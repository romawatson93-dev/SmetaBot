# ğŸ“‹ SmetaBot â€” Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ°

## ğŸ¯ ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°

Ğ”Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğµ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ SmetaBot â€” Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ´Ğ»Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ñ‘Ğ½Ğ½Ğ¾Ğ¹ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ ÑĞ¼ĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´Ñ‡Ğ¸ĞºĞ¾Ğ² ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°Ğ¼ Ñ‡ĞµÑ€ĞµĞ· Telegram.

**Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ:** Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ» ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹.

---

## ğŸ“‘ Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ

1. [ĞĞ±Ñ‰ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹](#1-Ğ¾Ğ±Ñ‰ĞµĞµ-Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ-ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹)
2. [ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²](#2-Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°-ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²)
3. [Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ User Flow Ğ¾Ñ‚ /start](#3-Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹-user-flow-Ğ¾Ñ‚-start)
4. [ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹](#4-Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸-Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹)
5. [Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğº Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸](#5-Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ-Ğº-Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸)
6. [API Ğ¸ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸](#6-api-Ğ¸-Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸)
7. [Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…](#7-Ğ±Ğ°Ğ·Ğ°-Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
8. [Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ](#8-Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ)

---

## 1. ĞĞ±Ñ‰ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

### 1.1. Ğ§Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°

SmetaBot â€” ÑÑ‚Ğ¾ Telegram-Ğ±Ğ¾Ñ‚, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´Ñ‡Ğ¸ĞºĞ°Ğ¼:
- Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ğµ Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ñ‘Ğ½Ğ½Ñ‹Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¾Ğ²
- Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ‚ÑŒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ (PDF, DOC, XLS) Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ñ… Ğ² PNG Ñ Ğ²Ğ¾Ğ´ÑĞ½Ñ‹Ğ¼ Ğ·Ğ½Ğ°ĞºĞ¾Ğ¼
- ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ñ… Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ¾Ğ¹ Ğ¾Ñ‚ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
- Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ğ´Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ ÑÑÑ‹Ğ»ĞºĞ¸-Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²
- ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¾Ğ² Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ

### 1.2. ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸

- **Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ°**: Ğ’ÑĞµ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ñ Ñ„Ğ»Ğ°Ğ³Ğ¾Ğ¼ `protect_content=True`, Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰Ñ‘Ğ½ Ñ„Ğ¾Ñ€Ğ²Ğ°Ñ€Ğ´Ğ¸Ğ½Ğ³
- **ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ**: PDF/DOC/XLS â†’ PNG 300 DPI Ñ Ğ²Ğ¾Ğ´ÑĞ½Ñ‹Ğ¼ Ğ·Ğ½Ğ°ĞºĞ¾Ğ¼
- **ĞœĞ½Ğ¾Ğ³Ğ¾Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°**: ĞÑ‚Ğ´ĞµĞ»ÑŒĞ½Ğ°Ñ MTProto-ÑĞµÑÑĞ¸Ñ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´Ñ‡Ğ¸ĞºĞ°
- **ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°**: Celery workers Ğ´Ğ»Ñ Ñ„Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡

---

## 2. ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²

### 2.1. ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ĞšĞĞœĞŸĞĞĞ•ĞĞ¢Ğ« Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ«                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Telegram Bot â”‚  â”‚  Userbot API â”‚  â”‚ Backend API  â”‚      â”‚
â”‚  â”‚  (aiogram)   â”‚  â”‚  (FastAPI +  â”‚  â”‚  (FastAPI)   â”‚      â”‚
â”‚  â”‚              â”‚  â”‚   Telethon)  â”‚  â”‚              â”‚      â”‚
â”‚  â”‚  - Handlers  â”‚  â”‚  - Sessions  â”‚  â”‚  - Health    â”‚      â”‚
â”‚  â”‚  - Services  â”‚  â”‚  - Channels  â”‚  â”‚  - WebApp    â”‚      â”‚
â”‚  â”‚  - FSM       â”‚  â”‚  - Login     â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚         â”‚ HTTP             â”‚ MTProto          â”‚ HTTP         â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Celery Workers                         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚  â”‚ Worker   â”‚  â”‚ Worker   â”‚  â”‚ Worker   â”‚       â”‚    â”‚
â”‚  â”‚  â”‚ PDF      â”‚  â”‚ Office   â”‚  â”‚ Publish  â”‚       â”‚    â”‚
â”‚  â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚       â”‚    â”‚
â”‚  â”‚  â”‚ PDFâ†’PNG  â”‚  â”‚ DOCâ†’PNG  â”‚  â”‚ Send to  â”‚       â”‚    â”‚
â”‚  â”‚  â”‚          â”‚  â”‚ XLSâ†’PNG  â”‚  â”‚ Channel  â”‚       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚    Redis     â”‚  â”‚  PostgreSQL  â”‚  â”‚ File System  â”‚    â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚    â”‚
â”‚  â”‚  - Queues    â”‚  â”‚  - core.*    â”‚  â”‚  - Sessions  â”‚    â”‚
â”‚  â”‚  - Cache     â”‚  â”‚  - billing.* â”‚  â”‚    (.enc)    â”‚    â”‚
â”‚  â”‚  - Temp filesâ”‚  â”‚  - analytics.*â”‚ â”‚              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2. Ğ’Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²

1. **Telegram Bot** Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
2. **Userbot API** Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ñ Telegram Ñ‡ĞµÑ€ĞµĞ· MTProto
3. **Celery Workers** Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ÑÑ‚ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ² Ñ„Ğ¾Ğ½Ğµ
4. **PostgreSQL** Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
5. **Redis** Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ĞµĞ¹ Ğ¸ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²

---

## 3. Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ User Flow Ğ¾Ñ‚ /start

### 3.1. ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° Ğ¾Ñ‚ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ğ­Ğ¢ĞĞŸ 1: Ğ¡Ğ¢ĞĞ Ğ¢ Ğ‘ĞĞ¢Ğ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: /start                                          â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Telegram Bot]                                         â”‚  â”‚
â”‚  â”‚  Handler: bot/handlers/menu.py::cmd_start               â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  1. Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ contractor_id = str(message.from_user.id)   â”‚  â”‚
â”‚  â”‚  2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ:                                    â”‚  â”‚
â”‚  â”‚     GET /session/status?contractor_id={id}               â”‚  â”‚
â”‚  â”‚  3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ init_ok Ğ² FSM state                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Userbot API]                                           â”‚  â”‚
â”‚  â”‚  Endpoint: GET /session/status                          â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»: {contractor_id}.session.enc         â”‚  â”‚
â”‚  â”‚  2. Ğ•ÑĞ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» ĞµÑÑ‚ÑŒ:                                      â”‚  â”‚
â”‚  â”‚     - Ğ Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Fernet(SESSION_SECRET)                â”‚  â”‚
â”‚  â”‚     - Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ StringSession                            â”‚  â”‚
â”‚  â”‚     - ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ verify=true)    â”‚  â”‚
â”‚  â”‚  3. Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ: {has_session: bool, authorized: bool}       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Telegram Bot]                                          â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ: REQUIRE_INIT_DATA && !init_ok                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Ğ•ÑĞ»Ğ¸ TRUE:                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ²Ñ…Ğ¾Ğ´ (WebApp)"        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - ĞĞ¶Ğ¸Ğ´Ğ°Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ‡ĞµÑ€ĞµĞ· WebApp                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Ğ’Ñ‹Ñ…Ğ¾Ğ´ Ğ¸Ğ· Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ°                             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ: has_session                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Ğ•ÑĞ»Ğ¸ FALSE:                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ñ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼Ğ¸ (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ)                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Ğ•ÑĞ»Ğ¸ TRUE:                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ñ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼Ğ¸                                        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2. Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ

ĞŸĞ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ `/start` Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ¼ĞµĞ½Ñ:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Ğ“Ğ›ĞĞ’ĞĞĞ• ĞœĞ•ĞĞ®             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ğŸ†• ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ°Ğ½Ğ°Ğ»                     â”‚
â”‚  ğŸ“¢ ĞœĞ¾Ğ¸ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹                      â”‚
â”‚  ğŸ”— ĞœĞ¾Ğ¸ ÑÑÑ‹Ğ»ĞºĞ¸                      â”‚
â”‚  ğŸ“„ Ğ ĞµĞ½Ğ´ĞµÑ€ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²                   â”‚
â”‚  ğŸ‘¤ Ğ›Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚                  â”‚
â”‚  â“ ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ                          â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸:**
- `ğŸ†• ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ°Ğ½Ğ°Ğ»` â†’ `bot/handlers/channel_wizard.py::start_wizard`
- `ğŸ“¢ ĞœĞ¾Ğ¸ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹` â†’ `bot/handlers/my_channels.py::show_channels_overview`
- `ğŸ“„ Ğ ĞµĞ½Ğ´ĞµÑ€ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²` â†’ `bot/handlers/menu.py::act_render_menu`
- ĞÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ â€” Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ¸ Ğ¸Ğ»Ğ¸ Ğ² Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ

### 3.3. Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹: ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· WebApp

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Ğ­Ğ¢ĞĞŸ 2: ĞĞ’Ğ¢ĞĞ Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ (ĞµÑĞ»Ğ¸ ÑĞµÑÑĞ¸Ğ¸ Ğ½ĞµÑ‚)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ "ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ²Ñ…Ğ¾Ğ´ (WebApp)"                â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [WebApp]                                               â”‚  â”‚
â”‚  â”‚  URL: {WEBAPP_URL}/webapp/login                         â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ:                                    â”‚  â”‚
â”‚  â”‚     GET /session/status?contractor_id={id}&verify=true  â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  2. Ğ•ÑĞ»Ğ¸ ÑĞµÑÑĞ¸Ğ¸ Ğ½ĞµÑ‚:                                     â”‚  â”‚
â”‚  â”‚     - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ²Ğ²Ğ¾Ğ´Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°                     â”‚  â”‚
â”‚  â”‚     - POST /login/phone/start {contractor_id, phone}    â”‚  â”‚
â”‚  â”‚     - ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ token                                     â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  3. ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ²Ğ²Ğ¾Ğ´Ğ° ĞºĞ¾Ğ´Ğ°                            â”‚  â”‚
â”‚  â”‚     - POST /login/phone/confirm {token, code}           â”‚  â”‚
â”‚  â”‚     - Ğ•ÑĞ»Ğ¸ 2FA: Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ                        â”‚  â”‚
â”‚  â”‚     - POST /login/phone/2fa {token, password}           â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  4. ĞŸĞ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑ…Ğ°:                                        â”‚  â”‚
â”‚  â”‚     - tg.sendData({action: "session_ready"})            â”‚  â”‚
â”‚  â”‚     - Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ WebApp                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Telegram Bot]                                          â”‚  â”‚
â”‚  â”‚  Handler: bot/handlers/webapp_gate.py                   â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ web_app_data                                â”‚  â”‚
â”‚  â”‚  2. ĞŸĞ°Ñ€ÑĞ¸Ñ‚ÑŒ JSON: {action: "session_ready"}              â”‚  â”‚
â”‚  â”‚  3. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ FSM: state.update_data(init_ok=True)       â”‚  â”‚
â”‚  â”‚  4. ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ:                            â”‚  â”‚
â”‚  â”‚     GET /session/status?contractor_id={id}&verify=true    â”‚  â”‚
â”‚  â”‚  5. ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ñ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼Ğ¸ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4. Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Ğ­Ğ¢ĞĞŸ 3: Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ• ĞšĞĞĞĞ›Ğ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: "ğŸ†• ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ°Ğ½Ğ°Ğ»"                                â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Telegram Bot]                                         â”‚  â”‚
â”‚  â”‚  Handler: channel_wizard.py::start_wizard              â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ: has_session(contractor_id)       â”‚  â”‚
â”‚  â”‚  2. Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ ÑĞµÑÑĞ¸Ğ¸:                                     â”‚  â”‚
â”‚  â”‚     - Ğ’ dev: Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "â˜ï¸ ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ñƒ"â”‚  â”‚
â”‚  â”‚     - Ğ’ prod: ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ ÑĞµÑÑĞ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Mini App"â”‚ â”‚
â”‚  â”‚     - Ğ’Ñ‹Ñ…Ğ¾Ğ´                                              â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  3. ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ FSM state                                   â”‚  â”‚
â”‚  â”‚  4. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ FSM state: CreateChannel.input_title      â”‚  â”‚
â”‚  â”‚  5. ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ‡ĞµĞº-Ğ»Ğ¸ÑÑ‚:                                   â”‚  â”‚
â”‚  â”‚     "â–«ï¸ 1) ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¾"                         â”‚  â”‚
â”‚  â”‚     "â–«ï¸ 2) ĞĞ²Ğ°Ñ‚Ğ°Ñ€ĞºĞ°: Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾"                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ğ°                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Telegram Bot]                                          â”‚  â”‚
â”‚  â”‚  Handler: channel_wizard.py::on_title                   â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  1. Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ: title.strip()[:64]                        â”‚  â”‚
â”‚  â”‚  2. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ FSM: state.update_data(title=title)         â”‚  â”‚
â”‚  â”‚  3. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ FSM state: CreateChannel.input_avatar     â”‚  â”‚
â”‚  â”‚  4. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ‡ĞµĞº-Ğ»Ğ¸ÑÑ‚:                                   â”‚  â”‚
â”‚  â”‚     "âœ… 1) ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: {title}"                            â”‚  â”‚
â”‚  â”‚     "â–«ï¸ 2) ĞĞ²Ğ°Ñ‚Ğ°Ñ€ĞºĞ°: Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾"                         â”‚  â”‚
â”‚  â”‚  5. ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸:                                     â”‚  â”‚
â”‚  â”‚     - "â­ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½ÑƒÑ"                        â”‚  â”‚
â”‚  â”‚     - "â­ï¸ ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€ĞºÑƒ:                        â”‚  â”‚
â”‚  â”‚  - Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ Ñ„Ğ¾Ñ‚Ğ¾ â†’ on_avatar_photo                     â”‚  â”‚
â”‚  â”‚  - "Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ°Ñ" â†’ callback cw:avatar:std               â”‚  â”‚
â”‚  â”‚  - "ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ" â†’ callback cw:avatar:skip               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Telegram Bot]                                          â”‚  â”‚
â”‚  â”‚  ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ‡ĞµĞº-Ğ»Ğ¸ÑÑ‚:                                      â”‚  â”‚
â”‚  â”‚  "âœ… 1) ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: {title}"                               â”‚  â”‚
â”‚  â”‚  "âœ… 2) ĞĞ²Ğ°Ñ‚Ğ°Ñ€ĞºĞ°: {ÑÑ‚Ğ°Ñ‚ÑƒÑ}"                             â”‚  â”‚
â”‚  â”‚  ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ"                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ"                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Telegram Bot]                                          â”‚  â”‚
â”‚  â”‚  Handler: channel_wizard.py::on_final                    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹:                                    â”‚  â”‚
â”‚  â”‚     billing.can_create_channel(contractor_id)            â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ°Ğ½Ğ°Ğ» Ñ‡ĞµÑ€ĞµĞ· Userbot:                         â”‚  â”‚
â”‚  â”‚     POST /rooms/create {                                â”‚  â”‚
â”‚  â”‚       contractor_id: str,                                â”‚  â”‚
â”‚  â”‚       title: str,                                        â”‚  â”‚
â”‚  â”‚       about: str (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)                           â”‚  â”‚
â”‚  â”‚     }                                                     â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  3. ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼:                      â”‚  â”‚
â”‚  â”‚     POST /rooms/add_bot_admin {                         â”‚  â”‚
â”‚  â”‚       contractor_id: str,                                â”‚  â”‚
â”‚  â”‚       channel_id: int,                                   â”‚  â”‚
â”‚  â”‚       bot_username: str                                  â”‚  â”‚
â”‚  â”‚     }                                                     â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  4. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾ (ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾):                    â”‚  â”‚
â”‚  â”‚     - Ğ§ĞµÑ€ĞµĞ· Bot API: set_chat_photo()                    â”‚  â”‚
â”‚  â”‚     - Ğ˜Ğ»Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Userbot: POST /rooms/set_photo          â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  5. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² Ğ‘Ğ”:                                      â”‚  â”‚
â”‚  â”‚     channels_service.create_project_channel(...)        â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  6. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ğ´Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²ÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ:                          â”‚  â”‚
â”‚  â”‚     bot.create_chat_invite_link(                        â”‚  â”‚
â”‚  â”‚       chat_id=channel_id,                                â”‚  â”‚
â”‚  â”‚       member_limit=1,                                    â”‚  â”‚
â”‚  â”‚       creates_join_request=True                          â”‚  â”‚
â”‚  â”‚     )                                                     â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  7. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ğ²Ğ°Ğ¹Ñ‚ Ğ² Ğ‘Ğ”:                               â”‚  â”‚
â”‚  â”‚     invites_service.create_invite(...)                    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  8. ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:                                  â”‚  â”‚
â”‚  â”‚     "âœ… ĞšĞ°Ğ½Ğ°Ğ» ÑĞ¾Ğ·Ğ´Ğ°Ğ½!"                                   â”‚  â”‚
â”‚  â”‚     "Ğ¡ÑÑ‹Ğ»ĞºĞ°: {invite_link}"                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.5. Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹: Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Ğ­Ğ¢ĞĞŸ 4: Ğ Ğ•ĞĞ”Ğ•Ğ  Ğ˜ ĞŸĞ£Ğ‘Ğ›Ğ˜ĞšĞĞ¦Ğ˜Ğ¯ Ğ”ĞĞšĞ£ĞœĞ•ĞĞ¢Ğ                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: "ğŸ“„ Ğ ĞµĞ½Ğ´ĞµÑ€ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²"                             â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Telegram Bot]                                          â”‚  â”‚
â”‚  â”‚  Handler: menu.py::act_render_menu                       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¼ĞµĞ½Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¾Ğ²:                                 â”‚  â”‚
â”‚  â”‚  - "ğŸ“„ PDF â†’ PNG"                                        â”‚  â”‚
â”‚  â”‚  - "ğŸ“Š Excel â†’ PNG"                                      â”‚  â”‚
â”‚  â”‚  - "ğŸ“ Word â†’ PNG"                                       â”‚  â”‚
â”‚  â”‚  - "ğŸ–¼ï¸ PNG Ğ² ĞºĞ°Ğ½Ğ°Ğ»"                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, "ğŸ“„ PDF â†’ PNG") â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Telegram Bot]                                          â”‚  â”‚
â”‚  â”‚  Handler: render_pdf.py::wait_for_pdf                    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ FSM state: RenderPDF.waiting_pdf             â”‚  â”‚
â”‚  â”‚  Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ: "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ PDF Ñ„Ğ°Ğ¹Ğ»"                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ PDF Ñ„Ğ°Ğ¹Ğ»                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Telegram Bot]                                          â”‚  â”‚
â”‚  â”‚  Handler: render_pdf.py::on_pdf_received                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  1. Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»: bot.get_file()                         â”‚  â”‚
â”‚  â”‚  2. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² Redis:                                    â”‚  â”‚
â”‚  â”‚     SET pdf:{uuid} [file_bytes] EX {TTL}                 â”‚  â”‚
â”‚  â”‚  3. ĞŸĞ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ¿Ñ€ĞµĞ²ÑŒÑ:                             â”‚  â”‚
â”‚  â”‚     generate_preview_task.delay(uuid, "pdf")              â”‚  â”‚
â”‚  â”‚  4. Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ: "Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒÑ Ğ¿Ñ€ĞµĞ²ÑŒÑ..."                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Celery Worker Preview]                                 â”‚  â”‚
â”‚  â”‚  Task: generate_preview_task                            â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  1. GET pdf:{uuid} Ğ¸Ğ· Redis                             â”‚  â”‚
â”‚  â”‚  2. PyMuPDF: PDF â†’ PNG (300 DPI)                         â”‚  â”‚
â”‚  â”‚  3. Pillow: PNG â†’ JPEG thumbnail (1600px)                 â”‚  â”‚
â”‚  â”‚  4. SET preview:{uuid} [thumbnail] EX {TTL}             â”‚  â”‚
â”‚  â”‚  5. Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ² Ğ±Ğ¾Ñ‚                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Telegram Bot]                                          â”‚  â”‚
â”‚  â”‚  ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:                           â”‚  â”‚
â”‚  â”‚  - Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ† Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°                      â”‚  â”‚
â”‚  â”‚  - ĞŸĞ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ° Ğ²Ğ¾Ğ´ÑĞ½Ğ¾Ğ³Ğ¾ Ğ·Ğ½Ğ°ĞºĞ° (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ username)    â”‚  â”‚
â”‚  â”‚  - ĞšĞ½Ğ¾Ğ¿ĞºĞ° "ĞĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ñ‚ÑŒ"                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ:                                            â”‚  â”‚
â”‚  â”‚  - Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ [1, 3, 5]                          â”‚  â”‚
â”‚  â”‚  - Ğ’Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ²Ğ¾Ğ´ÑĞ½Ğ¾Ğ¹ Ğ·Ğ½Ğ°Ğº: "Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ˜.Ğ˜."                    â”‚  â”‚
â”‚  â”‚  - ĞĞ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ "ĞĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ñ‚ÑŒ"                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Telegram Bot]                                          â”‚  â”‚
â”‚  â”‚  ĞŸĞ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³Ğ°:                            â”‚  â”‚
â”‚  â”‚  process_and_publish_pdf.delay(                          â”‚  â”‚
â”‚  â”‚    uuid, pages=[1,3,5], watermark="Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ˜.Ğ˜.",        â”‚  â”‚
â”‚  â”‚    channel_id, contractor_id                            â”‚  â”‚
â”‚  â”‚  )                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Celery Worker PDF]                                     â”‚  â”‚
â”‚  â”‚  Task: process_and_publish_pdf                           â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  1. GET pdf:{uuid} Ğ¸Ğ· Redis                              â”‚  â”‚
â”‚  â”‚  2. DEL pdf:{uuid} (Ğ¾Ğ´Ğ½Ğ¾ĞºÑ€Ğ°Ñ‚Ğ½Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ)                  â”‚  â”‚
â”‚  â”‚  3. PyMuPDF: PDF â†’ PNG 300 DPI Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ† [1,3,5]      â”‚  â”‚
â”‚  â”‚  4. Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹:                                 â”‚  â”‚
â”‚  â”‚     - apply_tiled_watermark(png, "Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ˜.Ğ˜.")          â”‚  â”‚
â”‚  â”‚     - SET renderpng:{uuid}-{page} [watermarked_png]      â”‚  â”‚
â”‚  â”‚  5. ĞŸĞ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸:                          â”‚  â”‚
â”‚  â”‚     send_document.delay(                                  â”‚  â”‚
â”‚  â”‚       channel_id, renderpng:{uuid}-{page}, filename       â”‚  â”‚
â”‚  â”‚     )                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Celery Worker Publish]                                 â”‚  â”‚
â”‚  â”‚  Task: send_document                                     â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  1. GET renderpng:{uuid}-{page} Ğ¸Ğ· Redis                â”‚  â”‚
â”‚  â”‚  2. Telegram Bot API:                                   â”‚  â”‚
â”‚  â”‚     sendDocument(                                        â”‚  â”‚
â”‚  â”‚       chat_id=channel_id,                                â”‚  â”‚
â”‚  â”‚       document=renderpng_bytes,                          â”‚  â”‚
â”‚  â”‚       filename="smeta-page-01.png",                      â”‚  â”‚
â”‚  â”‚       protect_content=True  â† Ğ—ĞĞ©Ğ˜Ğ¢Ğ                     â”‚  â”‚
â”‚  â”‚     )                                                     â”‚  â”‚
â”‚  â”‚  3. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ message_id Ğ¾Ñ‚ Telegram                       â”‚  â”‚
â”‚  â”‚  4. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² Ğ‘Ğ”:                                       â”‚  â”‚
â”‚  â”‚     INSERT INTO core.channel_files (                     â”‚  â”‚
â”‚  â”‚       channel_id, message_id, file_name, views=0         â”‚  â”‚
â”‚  â”‚     )                                                     â”‚  â”‚
â”‚  â”‚  5. DELETE renderpng:{uuid}-{page} Ğ¸Ğ· Redis              â”‚  â”‚
â”‚  â”‚  6. Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: "âœ… ĞĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ğ½Ğ¾"            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹

### 4.1. Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start

**Ğ¤Ğ°Ğ¹Ğ»:** `bot/handlers/menu.py`

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ:** `cmd_start`

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**

1. **Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:**
   ```python
   contractor_id = str(m.from_user.id)
   ```

2. **ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞµÑÑĞ¸Ğ¸:**
   ```python
   try:
       sess = await userbot_get("/session/status", {"contractor_id": contractor_id})
       has = bool(sess.get("has_session"))
   except Exception:
       has = False
   ```
   - Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ HTTP GET Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº Userbot API
   - Ğ•ÑĞ»Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ ÑƒÑĞ¿ĞµÑˆĞµĞ½ Ğ¸ `has_session == true`, ÑĞµÑÑĞ¸Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
   - ĞŸÑ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑĞµÑÑĞ¸Ğ¸ Ğ½ĞµÑ‚

3. **ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ‡ĞµÑ€ĞµĞ· WebApp:**
   ```python
   init_ok = bool((await state.get_data()).get("init_ok"))
   if REQUIRE_INIT_DATA and not init_ok:
       await m.answer("Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·ÑƒĞ¹Ñ‚ĞµÑÑŒ Ñ‡ĞµÑ€ĞµĞ· WebApp:", reply_markup=webapp_kb())
       return
   ```
   - Ğ’ production (`REQUIRE_INIT_DATA=true`) Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· WebApp
   - Ğ•ÑĞ»Ğ¸ `init_ok` Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½, Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ WebApp

4. **ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¼ĞµĞ½Ñ:**
   ```python
   await _ensure_main_menu(m, state, has)
   ```
   - Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ÑƒĞ¶Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Ğ¼ĞµĞ½Ñ (`menu_mid`)
   - Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ â€” Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ ĞµĞ³Ğ¾
   - Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ â€” ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
   - ĞœĞµĞ½Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ğ¾Ğµ Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ Ğ¾Ñ‚ `has_session` (Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ²)

### 4.2. Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ‡ĞµÑ€ĞµĞ· WebApp

**Ğ¤Ğ°Ğ¹Ğ»:** `bot/handlers/webapp_gate.py`

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ:** `mark_init_from_webapp`

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**

1. **ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· WebApp:**
   ```python
   raw = message.web_app_data.data
   payload = json.loads(raw)
   ```

2. **ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ:**
   ```python
   if payload.get("action") == "session_ready":
       await state.update_data(init_ok=True)
   ```
   - WebApp Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ `{action: "session_ready"}` Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
   - Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ `init_ok` Ğ² FSM state

**Ğ¤Ğ°Ğ¹Ğ»:** `userbot/api.py`

**Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚:** `POST /login/phone/start`

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**

1. **Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ TelegramClient:**
   ```python
   client = TelegramClient(StringSession(), API_ID, API_HASH)
   await client.connect()
   ```

2. **Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ğ½Ğ°:**
   ```python
   await client.send_code_request(phone)
   ```
   - ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ ĞºĞ¾Ğ´ Ğ² Telegram/SMS
   - Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ `_pending_phone[token] = {client, phone}`

3. **Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ token:**
   ```json
   {"token": "random_token_here"}
   ```

**Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚:** `POST /login/phone/confirm`

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**

1. **ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ¸Ğ· pending:**
   ```python
   pending = _pending_phone.get(token)
   client = pending["client"]
   ```

2. **ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ°:**
   ```python
   me = await client.sign_in(code=code)
   ```
   - Ğ•ÑĞ»Ğ¸ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ 2FA, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ `{status: "2fa_required"}`
   - Ğ•ÑĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ `{status: "ready", me: {...}}`

3. **Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸:**
   ```python
   session_string = client.session.save()
   encrypted = fernet.encrypt(session_string.encode())
   with open(f"{SESSIONS_DIR}/{contractor_id}.session.enc", "wb") as f:
       f.write(encrypted)
   ```

### 4.3. Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ°

**Ğ¤Ğ°Ğ¹Ğ»:** `bot/handlers/channel_wizard.py`

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ:** `start_wizard`

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**

1. **ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞµÑÑĞ¸Ğ¸:**
   ```python
   if not await has_session(contractor_id):
       # ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
       return
   ```

2. **Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ FSM:**
   ```python
   await state.clear()
   await state.update_data(
       step=1,
       title=None,
       avatar_state=None,
       avatar_bytes=None,
       card_mid=None
   )
   await state.set_state(CreateChannel.input_title)
   ```

3. **ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ñ‡ĞµĞº-Ğ»Ğ¸ÑÑ‚Ğ°:**
   ```python
   await _render_card(bot, chat_id, state, hint, keyboard)
   ```
   - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Ñ‡ĞµĞº-Ğ»Ğ¸ÑÑ‚Ğ¾Ğ¼
   - `card_mid` ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ² state Ğ´Ğ»Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ:** `on_final` (callback `cw:final3`)

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**

1. **ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸:**
   ```python
   data = await state.get_data()
   if not _is_ready(data):
       return  # ĞĞµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾
   ```

2. **Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ğ° Ñ‡ĞµÑ€ĞµĞ· Userbot:**
   ```python
   result = await userbot_post("/rooms/create", {
       "contractor_id": contractor_id,
       "title": data["title"],
       "about": ""  # Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾
   })
   channel_id = result["channel_id"]
   ```

3. **ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼:**
   ```python
   await userbot_post("/rooms/add_bot_admin", {
       "contractor_id": contractor_id,
       "channel_id": channel_id,
       "bot_username": BOT_USERNAME
   })
   ```

4. **Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ñ„Ğ¾Ñ‚Ğ¾ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ):**
   ```python
   if data.get("avatar_bytes"):
       # Ğ§ĞµÑ€ĞµĞ· Bot API Ğ¸Ğ»Ğ¸ Userbot API
       await bot.set_chat_photo(channel_id, BufferedInputFile(...))
   ```

5. **Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Ğ‘Ğ”:**
   ```python
   await channels_service.create_project_channel(
       contractor_id=contractor_id,
       tg_chat_id=channel_id,
       title=data["title"]
   )
   ```

6. **Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ½Ğ²Ğ°Ğ¹Ñ‚Ğ°:**
   ```python
   invite_link = await bot.create_chat_invite_link(
       chat_id=channel_id,
       member_limit=1,
       creates_join_request=True
   )
   await invites_service.create_invite(channel_id, invite_link.invite_link)
   ```

### 4.4. Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²

**Ğ¤Ğ°Ğ¹Ğ»:** `bot/handlers/render_pdf.py`

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ:** `on_pdf_received`

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**

1. **Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ°:**
   ```python
   file = await bot.get_file(document.file_id)
   file_bytes = await bot.download_file(file.file_path)
   ```

2. **Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Redis:**
   ```python
   uuid = str(uuid4())
   await redis.setex(
       f"pdf:{uuid}",
       SOURCE_BLOB_TTL,  # 24 Ñ‡Ğ°ÑĞ°
       file_bytes
   )
   ```

3. **ĞŸĞ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ñ€ĞµĞ²ÑŒÑ:**
   ```python
   from worker.tasks.preview import generate_preview_task
   generate_preview_task.delay(uuid, "pdf")
   ```

**Ğ¤Ğ°Ğ¹Ğ»:** `worker/tasks/render/__init__.py`

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ:** `process_and_publish_pdf`

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**

1. **Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ°:**
   ```python
   pdf_bytes = await redis.get(f"pdf:{uuid}")
   await redis.delete(f"pdf:{uuid}")  # ĞĞ´Ğ½Ğ¾ĞºÑ€Ğ°Ñ‚Ğ½Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ
   ```

2. **ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² PNG:**
   ```python
   import fitz  # PyMuPDF
   doc = fitz.open(stream=pdf_bytes, filetype="pdf")
   for page_num in pages:
       page = doc[page_num - 1]  # 0-indexed
       mat = fitz.Matrix(300/72, 300/72)  # 300 DPI
       pix = page.get_pixmap(matrix=mat)
       png_bytes = pix.tobytes("png")
   ```

3. **ĞĞ°Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ²Ğ¾Ğ´ÑĞ½Ğ¾Ğ³Ğ¾ Ğ·Ğ½Ğ°ĞºĞ°:**
   ```python
   from worker.tasks.watermark import apply_tiled_watermark
   watermarked_png = apply_tiled_watermark(png_bytes, watermark_text)
   ```

4. **Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°:**
   ```python
   await redis.setex(
       f"renderpng:{uuid}-{page_num}",
       FULLRES_BLOB_TTL,  # 12 Ñ‡Ğ°ÑĞ¾Ğ²
       watermarked_png
   )
   ```

5. **ĞŸĞ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸:**
   ```python
   from worker.tasks.publish import send_document
   for page_num in pages:
       send_document.delay(
           channel_id=channel_id,
           document_key=f"renderpng:{uuid}-{page_num}",
           filename=f"smeta-page-{page_num:02d}.png",
           caption=""
       )
   ```

**Ğ¤Ğ°Ğ¹Ğ»:** `worker/tasks/publish.py`

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ:** `send_document`

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:**

1. **ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°:**
   ```python
   document_bytes = await redis.get(document_key)
   ```

2. **ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ‡ĞµÑ€ĞµĞ· Bot API:**
   ```python
   from aiogram import Bot
   bot = Bot(token=BOT_TOKEN)
   message = await bot.send_document(
       chat_id=channel_id,
       document=BufferedInputFile(document_bytes, filename),
       caption=caption,
       protect_content=True  # Ğ—ĞĞ©Ğ˜Ğ¢Ğ
   )
   ```

3. **Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Ğ‘Ğ”:**
   ```python
   await channels_service.record_channel_file(
       channel_id=channel_id,
       message_id=message.message_id,
       file_name=filename,
       file_type="image/png"
   )
   ```

4. **ĞÑ‡Ğ¸ÑÑ‚ĞºĞ°:**
   ```python
   await redis.delete(document_key)
   ```

---

## 5. Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğº Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### 5.1. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start

**Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:**

1. âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Userbot API
2. âœ… Ğ’ production Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· WebApp (`REQUIRE_INIT_DATA=true`)
3. âœ… Ğ’ dev Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞ°Ñ‚ÑŒ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ»Ğ¾Ğ³Ğ¸Ğ½ Ğ±ĞµĞ· WebApp
4. âœ… ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ Ğ¾Ñ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° ÑĞµÑÑĞ¸Ğ¸
5. âœ… Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸, Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‰Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸, Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ²

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ:**

```python
@router.message(Command("start"))
async def cmd_start(m: Message, state: FSMContext):
    contractor_id = str(m.from_user.id)
    try:
        sess = await userbot_get("/session/status", {"contractor_id": contractor_id})
        has = bool(sess.get("has_session"))
    except Exception:
        has = False
    init_ok = bool((await state.get_data()).get("init_ok"))
    if REQUIRE_INIT_DATA and not init_ok:
        await m.answer("Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·ÑƒĞ¹Ñ‚ĞµÑÑŒ Ñ‡ĞµÑ€ĞµĞ· WebApp:", reply_markup=webapp_kb())
        return
    await _ensure_main_menu(m, state, has)
```

### 5.2. ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· WebApp

**Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:**

1. âœ… WebApp Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ ÑĞµÑÑĞ¸Ñ
2. âœ… Ğ•ÑĞ»Ğ¸ ÑĞµÑÑĞ¸Ğ¸ Ğ½ĞµÑ‚ â€” Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ñ‹Ğ¹ flow
3. âœ… ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ 2FA (Ğ´Ğ²ÑƒÑ…Ñ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ½ÑƒÑ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ)
4. âœ… ĞŸĞ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑ…Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ `session_ready` Ğ² Ğ±Ğ¾Ñ‚
5. âœ… Ğ‘Ğ¾Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒ `init_ok` Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ ÑĞµÑÑĞ¸Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ WebApp (Ğ¿ÑĞµĞ²Ğ´Ğ¾ĞºĞ¾Ğ´):**

```javascript
// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞµÑÑĞ¸Ğ¸
const response = await fetch(`/session/status?contractor_id=${contractorId}&verify=true`);
const { has_session, authorized } = await response.json();

if (!has_session || !authorized) {
    // Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ğ½Ğ°
    const startResponse = await fetch('/login/phone/start', {
        method: 'POST',
        body: JSON.stringify({ contractor_id: contractorId, phone: phone })
    });
    const { token } = await startResponse.json();
    
    // Ğ’Ğ²Ğ¾Ğ´ ĞºĞ¾Ğ´Ğ°
    const confirmResponse = await fetch('/login/phone/confirm', {
        method: 'POST',
        body: JSON.stringify({ token, code })
    });
    const { status } = await confirmResponse.json();
    
    if (status === '2fa_required') {
        // Ğ’Ğ²Ğ¾Ğ´ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ 2FA
        const twofaResponse = await fetch('/login/phone/2fa', {
            method: 'POST',
            body: JSON.stringify({ token, password })
        });
    }
    
    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ² Ğ±Ğ¾Ñ‚
    window.Telegram.WebApp.sendData(JSON.stringify({ action: 'session_ready' }));
}
```

### 5.3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ğ°

**Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:**

1. âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸ Ğ¿ĞµÑ€ĞµĞ´ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾Ğ¼
2. âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ FSM Ğ´Ğ»Ñ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ÑˆĞ°Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°
3. âœ… Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ¼Ğ°ĞºÑ. 64 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°)
4. âœ… ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ñ€Ğ¸ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ° Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€ĞºĞ¸: ĞºĞ°ÑÑ‚Ğ¾Ğ¼, ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ°Ñ, Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ
5. âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ¿ĞµÑ€ĞµĞ´ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸ĞµĞ¼
6. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ĞºĞ°Ğ½Ğ°Ğ» Ñ `ToggleNoForwardsRequest`
7. âœ… ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸: post_messages, invite_users
8. âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ğ‘Ğ”
9. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ğ´Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²ÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ-Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ğµ

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ:**

Ğ¡Ğ¼. Ñ€Ğ°Ğ·Ğ´ĞµĞ» 4.3 "Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ°"

### 5.4. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²

**Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:**

1. âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² Redis Ñ TTL
2. âœ… Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ²ÑŒÑ Ğ´Ğ»Ñ PDF/DOC/XLS
3. âœ… ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
4. âœ… ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºÑƒ Ğ²Ğ¾Ğ´ÑĞ½Ğ¾Ğ³Ğ¾ Ğ·Ğ½Ğ°ĞºĞ°
5. âœ… ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² PNG 300 DPI
6. âœ… ĞĞ°ĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ°Ğ¹Ğ»Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ğ¾Ğ´ÑĞ½Ğ¾Ğ¹ Ğ·Ğ½Ğ°Ğº
7. âœ… ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ñ‚ÑŒ Ñ `protect_content=True`
8. âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ğ‘Ğ”
9. âœ… Ğ£Ğ´Ğ°Ğ»ÑÑ‚ÑŒ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ:**

Ğ¡Ğ¼. Ñ€Ğ°Ğ·Ğ´ĞµĞ» 4.4 "Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²"

---

## 6. API Ğ¸ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸

### 6.1. Userbot API

**Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ URL:** `http://userbot:8001` (Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹) Ğ¸Ğ»Ğ¸ `https://orbitsend.ru` (Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¹)

#### GET /session/status

**ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:**
- `contractor_id` (str, Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹)
- `verify` (bool, Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾) â€” Ñ€ĞµĞºĞ¾Ğ½Ğ½ĞµĞºÑ‚ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸

**ĞÑ‚Ğ²ĞµÑ‚:**
```json
{
  "has_session": true,
  "authorized": true
}
```

#### POST /rooms/create

**Ğ¢ĞµĞ»Ğ¾:**
```json
{
  "contractor_id": "123456789",
  "title": "ĞŸÑ€Ğ¾ĞµĞºÑ‚ Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ°",
  "about": "ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°"
}
```

**ĞÑ‚Ğ²ĞµÑ‚:**
```json
{
  "channel_id": -1001234567890
}
```

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:**
1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ: `{contractor_id}.session.enc`
2. Ğ Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Fernet
3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ TelegramClient
4. Ğ’Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ `CreateChannelRequest(title, about)`
5. Ğ’Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ `ToggleNoForwardsRequest(enabled=True)`
6. Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ `channel_id`

#### POST /rooms/add_bot_admin

**Ğ¢ĞµĞ»Ğ¾:**
```json
{
  "contractor_id": "123456789",
  "channel_id": -1001234567890,
  "bot_username": "@smetabot"
}
```

**ĞÑ‚Ğ²ĞµÑ‚:**
```json
{
  "ok": true
}
```

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:**
1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ
2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ TelegramClient
3. Ğ’Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ `EditAdminRequest` Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸:
   - `post_messages=True`
   - `invite_users=True`
   - `change_info=True`
   - ĞÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ `False`

### 6.2. Celery Tasks

#### generate_preview_task

**ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ:** `preview`

**ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:**
- `file_uuid` (str)
- `file_type` (str): "pdf", "doc", "xls"

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:**
1. GET Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ· Redis: `{file_type}:{uuid}`
2. ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² PNG (PyMuPDF/LibreOffice)
3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ thumbnail JPEG 1600px (Pillow)
4. SET Ğ¿Ñ€ĞµĞ²ÑŒÑ Ğ² Redis: `preview:{uuid}` Ñ TTL
5. Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ² Ğ±Ğ¾Ñ‚

#### process_and_publish_pdf

**ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ:** `pdf`

**ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:**
- `file_uuid` (str)
- `pages` (List[int])
- `watermark_text` (str)
- `channel_id` (int)
- `contractor_id` (str)

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:**
1. GET Ğ¸ DEL Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ· Redis (Ğ¾Ğ´Ğ½Ğ¾ĞºÑ€Ğ°Ñ‚Ğ½Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ)
2. ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ² PNG 300 DPI
3. ĞĞ°Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ğ´ÑĞ½Ğ¾Ğ¹ Ğ·Ğ½Ğ°Ğº
4. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² Redis: `renderpng:{uuid}-{page}`
5. ĞŸĞ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ `send_document` Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹

#### send_document

**ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ:** `publish`

**ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:**
- `channel_id` (int)
- `document_key` (str): ĞºĞ»ÑÑ‡ Ğ² Redis
- `filename` (str)
- `caption` (str)

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:**
1. GET Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¸Ğ· Redis
2. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Bot API Ñ `protect_content=True`
3. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² Ğ‘Ğ”: `core.channel_files`
4. DELETE Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¸Ğ· Redis

---

## 7. Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### 7.1. ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹

#### core.contractors

```sql
CREATE TABLE core.contractors (
    id BIGSERIAL PRIMARY KEY,
    tg_user_id BIGINT UNIQUE NOT NULL,
    username TEXT,
    full_name TEXT,
    status TEXT CHECK (status IN ('active', 'blocked')),
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### core.channels

```sql
CREATE TABLE core.channels (
    id BIGSERIAL PRIMARY KEY,
    contractor_id BIGINT NOT NULL REFERENCES core.contractors(id),
    tg_chat_id BIGINT UNIQUE NOT NULL,
    title TEXT NOT NULL,
    username TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by_bot BOOLEAN DEFAULT true,
    synced BOOLEAN DEFAULT false,
    last_synced_at TIMESTAMPTZ
);
```

#### core.channel_files

```sql
CREATE TABLE core.channel_files (
    id BIGSERIAL PRIMARY KEY,
    channel_id BIGINT NOT NULL REFERENCES core.channels(id),
    message_id BIGINT NOT NULL,
    file_name TEXT NOT NULL,
    file_type TEXT NOT NULL,
    views INTEGER DEFAULT 0,
    posted_at TIMESTAMPTZ DEFAULT NOW(),
    deleted BOOLEAN DEFAULT false,
    UNIQUE (channel_id, message_id)
);
```

#### core.project_invites

```sql
CREATE TABLE core.project_invites (
    id BIGSERIAL PRIMARY KEY,
    channel_id BIGINT NOT NULL REFERENCES core.channels(id),
    token TEXT UNIQUE NOT NULL,
    expires_at TIMESTAMPTZ,
    max_uses INTEGER,
    used_count INTEGER DEFAULT 0,
    editable BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 7.2. Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹

```sql
CREATE INDEX idx_channels_contractor ON core.channels(contractor_id);
CREATE INDEX idx_channel_files_channel_posted ON core.channel_files(channel_id, posted_at DESC);
CREATE INDEX idx_project_invites_channel ON core.project_invites(channel_id);
```

---

## 8. Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

### 8.1. Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ°

1. **Telegram-ĞºĞ°Ğ½Ğ°Ğ»Ñ‹:**
   - Ğ’ÑĞµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°ÑÑ‚ÑÑ Ñ `ToggleNoForwardsRequest(enabled=True)`
   - Ğ’ÑĞµ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ñ `protect_content=True`
   - Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºÑƒÑÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ°Ğº `document` (Ğ½Ğµ Ñ„Ğ¾Ñ‚Ğ¾/Ğ²Ğ¸Ğ´ĞµĞ¾)

2. **Ğ’Ğ¾Ğ´ÑĞ½Ñ‹Ğµ Ğ·Ğ½Ğ°ĞºĞ¸:**
   - Ğ¢Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ¾Ğµ Ğ½Ğ°Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğ° Ğ²ÑĞµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
   - ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸: opacity, step, angle, color, font
   - Ğ¢ĞµĞºÑÑ‚ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: username Ğ¿Ğ¾Ğ´Ñ€ÑĞ´Ñ‡Ğ¸ĞºĞ°

### 8.2. Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞµÑÑĞ¸ÑĞ¼Ğ¸

1. **Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**
   - Ğ¡ĞµÑÑĞ¸Ğ¸ ÑˆĞ¸Ñ„Ñ€ÑƒÑÑ‚ÑÑ Fernet Ğ¿ĞµÑ€ĞµĞ´ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸ĞµĞ¼
   - ĞšĞ»ÑÑ‡: `SESSION_SECRET` Ğ¸Ğ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
   - Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ„Ğ°Ğ¹Ğ»Ğ°: `{contractor_id}.session.enc`

2. **Ğ˜Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ:**
   - ĞÑ‚Ğ´ĞµĞ»ÑŒĞ½Ğ°Ñ ÑĞµÑÑĞ¸Ñ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´Ñ‡Ğ¸ĞºĞ°
   - Ğ¡ĞµÑÑĞ¸Ğ¸ Ğ½Ğµ Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ÑÑ‚ÑÑ
   - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹

### 8.3. Ğ˜Ğ½Ğ²Ğ°Ğ¹Ñ‚Ñ‹

1. **ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ:**
   - ĞĞ´Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ ÑÑÑ‹Ğ»ĞºĞ¸: `member_limit=1`
   - TTL: `expires_at` (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
   - Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹: `max_uses` (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)

2. **Join-requests:**
   - Ğ’ÑĞµ Ğ¸Ğ½Ğ²Ğ°Ğ¹Ñ‚Ñ‹ Ñ `creates_join_request=True`
   - Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´Ñ‡Ğ¸ĞºĞ¾Ğ¼ Ğ¸Ğ»Ğ¸ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼
   - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¾Ğ²

---

## ğŸ“ ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ°

### Ğ’Ğ°Ğ¶Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ñ‹:

1. **FSM State Management:**
   - Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¾Ñ‡Ğ¸Ñ‰Ğ°Ğ¹Ñ‚Ğµ state Ğ¿ĞµÑ€ĞµĞ´ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾Ğ¼ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°
   - Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¼ĞµĞ¶ÑƒÑ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² `state.update_data()`
   - Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ `state.set_state()` Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ¼ĞµĞ¶Ğ´Ñƒ ÑÑ‚Ğ°Ğ¿Ğ°Ğ¼Ğ¸

2. **ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº:**
   - Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¾Ğ±Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°Ğ¹Ñ‚Ğµ HTTP-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ² try/except
   - Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ±ĞµĞ· Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
   - ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ

3. **Redis TTL:**
   - Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹: `SOURCE_BLOB_TTL` (24 Ñ‡Ğ°ÑĞ°)
   - ĞŸÑ€ĞµĞ²ÑŒÑ: `PREVIEW_BLOB_TTL` (1 Ñ‡Ğ°Ñ)
   - Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğµ PNG: `FULLRES_BLOB_TTL` (12 Ñ‡Ğ°ÑĞ¾Ğ²)

4. **Celery Tasks:**
   - Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸: `pdf`, `office`, `publish`, `preview`
   - Ğ£Ğ´Ğ°Ğ»ÑĞ¹Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸Ğ· Redis Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
   - ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ¹Ñ‚Ğµ retry Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ… Telegram API

5. **Telegram API:**
   - Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ `protect_content=True` Ğ¿Ñ€Ğ¸ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
   - ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ¹Ñ‚Ğµ FloodWait Ñ‡ĞµÑ€ĞµĞ· `with_floodwait`
   - Retry Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ… 403, 429, 400

---

**Ğ’ĞµÑ€ÑĞ¸Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°:** 1.0  
**Ğ”Ğ°Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ:** 2024  
**ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ:** 2024

