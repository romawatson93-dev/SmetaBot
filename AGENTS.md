# ü§ñ SmetaBot ‚Äî –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≥–µ–Ω—Ç–æ–≤

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
SmetaBot –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –∑–∞—â–∏—â—ë–Ω–Ω—É—é –≤—ã–¥–∞—á—É —Å–º–µ—Ç –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞–º –≤ Telegram. –°–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–∞–Ω–∞–ª—ã, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ PNG 300 DPI —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. –ù–∏–∂–µ ‚Äî –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–µ–π –∞–≥–µ–Ω—Ç–æ–≤ –∏ –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞ —Ç–µ–∫—É—â–∏–π –∫–æ–¥.

## üß© –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏
### Telegram Bot (`bot/`)
- aiogram 3.13 (`bot/main.py`) —Å–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π; –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –≤—Å–µ —Ä–æ—É—Ç–µ—Ä—ã: –º–µ–Ω—é, –º–∞—Å—Ç–µ—Ä–∞, –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –ø—Ä–æ—Ñ–∏–ª–∏.
- –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º: —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–µ–Ω—é, WebApp-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –º–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤, —Ä–∞–∑–¥–µ–ª—ã ¬´–ú–æ–∏ –∫–∞–Ω–∞–ª—ã¬ª/¬´–†–µ–Ω–¥–µ—Ä —Ñ–∞–π–ª–æ–≤¬ª/¬´–ü—Ä–æ—Ñ–∏–ª—å¬ª.
- –û–±—â–∞–µ—Ç—Å—è —Å userbot –ø–æ HTTP (`userbot_post`, `userbot_get`), —Å Celery worker‚Äô–æ–º —á–µ—Ä–µ–∑ `bot/celery_client.py`, —Å Redis –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∏–Ω–∞—Ä–µ–π (`bot/storage.py`) –∏ —Å PostgreSQL —á–µ—Ä–µ–∑ `bot/services/db.py`.
- –°—Ç–∞–≤–∏—Ç —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ —Ä–µ–Ω–¥–µ—Ä–∞/–ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Celery (`tasks.render.*`, `tasks.publish.send_document`), –∞ —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –≤ –ë–î (—Ç–∞–±–ª–∏—Ü—ã `projects`, `channels`, `channel_files` –∏ –¥—Ä.).
- –†–µ–∞–ª–∏–∑—É–µ—Ç dev-—Ñ–æ–ª–±—ç–∫ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞ –±–µ–∑ WebApp (–∫–æ–º–∞–Ω–¥—ã `/phone`, callback `conn_phone`).

### Userbot API (`userbot/`)
- FastAPI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (`userbot/api.py`) –ø–æ–≤–µ—Ä—Ö Telethon. –ö–∞–∂–¥–æ–º—É –ø–æ–¥—Ä—è–¥—á–∏–∫—É —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–∞—è MTProto-—Å–µ—Å—Å–∏—è.
- –°–µ—Å—Å–∏–∏ —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è –≤ StringSession –∏ —à–∏—Ñ—Ä—É—é—Ç—Å—è Fernet (`SESSION_SECRET`) –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –Ω–∞ –¥–∏—Å–∫ –≤ `SESSIONS_DIR`.
- –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:
  - `GET /session/status` (—Å –æ–ø—Ü–∏–µ–π `verify=true` —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∏—Ç –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏).
  - `POST /login/phone/start`, `/login/phone/confirm`, `/login/phone/2fa` ‚Äî –ø–æ–ª–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π flow –¥–ª—è dev/desktop.
  - `GET /webapp/login`, `GET /webapp/login2` ‚Äî Mini App-—Å—Ç—Ä–∞–Ω–∏—Ü—ã, –æ—Ç–ø—Ä–∞–≤–ª—è—é—â–∏–µ `session_ready` –≤ –±–æ—Ç–∞.
  - `POST /rooms/create` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–∞–Ω–∞–ª, –≤–∫–ª—é—á–∞–µ—Ç `ToggleNoForwardsRequest`.
  - `POST /rooms/add_bot_admin` ‚Äî –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –±–æ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º (–ø—Ä–∞–≤–∞: –ø–æ—Å—Ç–∏–Ω–≥, –∏–Ω–≤–∞–π—Ç—ã).
  - `POST /rooms/set_photo` ‚Äî —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ –∫–∞–Ω–∞–ª–∞ —á–µ—Ä–µ–∑ Telethon (fallback –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è).
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç FloodWait —á–µ—Ä–µ–∑ `with_floodwait`, –¥–æ–∂–∏–¥–∞–µ—Ç—Å—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—ã –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–π.

### Celery worker (`worker/`)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `worker/celery_app.py`: –æ—á–µ—Ä–µ–¥–∏ `pdf`, `office`, `publish`, `preview`, –µ–¥–∏–Ω—ã–π –±—Ä–æ–∫–µ—Ä Redis.
- –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ (`worker/tasks/render/__init__.py`):
  - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è PDF (PyMuPDF), DOC/DOCX (LibreOffice ‚Üí PDF ‚Üí PNG), XLS/XLSX/ODS (LibreOffice + PyMuPDF) –≤ PNG 300 DPI.
  - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–∞–π–ª–æ–≤–æ–≥–æ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ (`tasks.watermark.apply_tiled_watermark`, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ `common/watermark.py`).
  - –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ –∫–∞–Ω–∞–ª —á–µ—Ä–µ–∑ Telegram Bot API (`tasks.publish.send_document`) —Å —Ä–µ—Ç—Ä–∞—è–º–∏ –∏ `protect_content=True`.
  - –ó–∞–ø–∏—Å—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL (`channels_service.record_channel_file`, —Å–Ω–∞–ø—à–æ—Ç—ã, —É—á—ë—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤).
- –ü—Ä–µ–≤—å—é –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (`tasks.preview.generate_preview_task`) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—â—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É `common/preview.py`, —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç –ø—Ä–µ–≤—å—é/—Ñ—É–ª–ª—Ä–µ–∑ –≤ Redis —Å TTL.
- –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π ‚Äî `worker/metrics.py` (Prometheus, –∞–≤—Ç–æ–æ—Ç—á—ë—Ç—ã –≤ –ª–æ–≥).

### Backend (`backend/`)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ FastAPI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (`backend/app/main.py`): `GET /health` –∏ –¥–µ–º–æ-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ WebApp –ª–æ–≥–∏–Ω–∞.
- API –¥–ª—è CRUD-–ø—Ä–æ—Ü–µ–¥—É—Ä (contractors/rooms/documents/invites) –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –ø–æ–∫–∞ –Ω–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ –±–æ—Ç–∞ ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ `bot/handlers/invite_manage.py` –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–º—É REST-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—É.

### –û–±—â–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- `common/preview.py` ‚Äî –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é: PyMuPDF, Pillow, LibreOffice, Ghostscript; —É–º–µ–µ—Ç –∏—Å–∫–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤ Excel.
- `common/watermark.py` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
- Redis: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (`pdf:<uuid>`, `doc:<uuid>`, `renderpng:<uuid>`), –ø—Ä–µ–≤—å—é (`preview:<uuid>`); TTL —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `SOURCE_BLOB_TTL`, `FULLRES_BLOB_TTL`.
- PostgreSQL: —Å—Ö–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ `infra/migrations/0001_init.sql`, `0002_channels.sql`.
- Docker-—Ñ–∞–π–ª—ã –∏ compose-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ª–µ–∂–∞—Ç –≤ `infra/docker/` –∏ –∫–æ—Ä–Ω–µ–≤—ã—Ö `docker-compose*.yml`.

## üîÑ –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

### –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –ø–æ–¥—Ä—è–¥—á–∏–∫–∞
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞—Ä—Ç—É–µ—Ç –±–æ—Ç–∞ (`/start` –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–∫—Ä—ã—Ç—å –≤—Ö–æ–¥ (WebApp)¬ª). –í prod —Ç—Ä–µ–±—É–µ—Ç—Å—è WebApp init data (`REQUIRE_INIT_DATA=true`).
2. –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (`WEBAPP_URL` ‚Üí `userbot/api.py::webapp_login`) –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π flow –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `session_ready` –æ–±—Ä–∞—Ç–Ω–æ –≤ —á–∞—Ç.
3. –ë–æ—Ç –ø–æ–º–µ—á–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ `init_ok` (`bot/handlers/webapp_gate.py`), –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `/session/status?verify=true` –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–µ –º–µ–Ω—é.
4. –í dev-—Å—Ä–µ–¥–∞—Ö –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä—è–º–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π login (`/phone`, callback `conn_phone`), –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ `/login/phone/*` –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –º–µ–Ω—é –±–µ–∑ WebApp.

### –ú–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—â–∏—â—ë–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
1. –†–∞–∑–¥–µ–ª ¬´üÜï –ù–æ–≤—ã–π –∫–∞–Ω–∞–ª¬ª (`bot/handlers/channel_wizard.py`) —Å–æ–±–∏—Ä–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∞–≤–∞—Ç–∞—Ä–∫—É (–≤–∞—Ä–∏–∞–Ω—Ç—ã: –∫–∞—Å—Ç–æ–º, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è, –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å).
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏. –í dev –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ ¬´‚òéÔ∏è –ü–æ–¥–∫–ª—é—á–∏—Ç—å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É¬ª.
3. Userbot —Å–æ–∑–¥–∞—ë—Ç –∫–∞–Ω–∞–ª (`/rooms/create`), –≤–∫–ª—é—á–∞–µ—Ç `noforwards/protected_content`, –±–æ—Ç –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç —Å–µ–±—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (`/rooms/add_bot_admin`).
4. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, —Ñ–æ—Ç–æ –∫–∞–Ω–∞–ª–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ API –±–æ—Ç–∞ –ª–∏–±–æ `rooms/set_photo`.
5. –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞ –∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ PostgreSQL (`channels_service.create_project_channel`).
6. –°–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ (`Bot.create_chat_invite_link(member_limit=1)`), —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ `project_invites`.
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —á–µ–∫-–ª–∏—Å—Ç –∏ —Å—Å—ã–ª–∫—É –Ω–∞ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (—Ä–µ–Ω–¥–µ—Ä, —Å—Å—ã–ª–∫–∏).

### –ú–µ–Ω—é –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (`bot/handlers/menu.py`) –≤–∫–ª—é—á–∞–µ—Ç ¬´–ú–æ–∏ –∫–∞–Ω–∞–ª—ã¬ª, ¬´–ú–æ–∏ —Å—Å—ã–ª–∫–∏¬ª, ¬´–†–µ–Ω–¥–µ—Ä —Ñ–∞–π–ª–æ–≤¬ª, ¬´–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç¬ª, ¬´–ü–æ–º–æ—â—å¬ª.
- ¬´üì¢ –ú–æ–∏ –∫–∞–Ω–∞–ª—ã¬ª (`bot/handlers/my_channels.py`) –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: —Å—É–º–º–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã/–ø—Ä–æ—Å–º–æ—Ç—Ä—ã, –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç—ã, –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–Ω–∞–ª–æ–≤ —Å –≤—ã–≥—Ä—É–∑–∫–æ–π —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ Telegram API.
- ¬´üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç¬ª (`bot/handlers/profile.py`) –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∞–≤–∞—Ç–∞—Ä–∫—É –¥–ª—è –±—É–¥—É—â–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏.
- –†–∞–∑–¥–µ–ª ¬´üîó –ú–æ–∏ —Å—Å—ã–ª–∫–∏¬ª –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ—Å–ª–µ –ø–æ—è–≤–ª–µ–Ω–∏—è REST —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –≤ backend; —Å–µ–π—á–∞—Å –≤—ã–¥–∞–Ω–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ/–∑–∞–≥–ª—É—à–∫–∞.

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
1. –ü–æ–¥—Ä—è–¥—á–∏–∫ –≤—ã–±–∏—Ä–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç (¬´üìÑ PDF ‚Üí PNG¬ª, ¬´üìä Excel ‚Üí PNG¬ª, ¬´üìù Word ‚Üí PNG¬ª, ¬´üñºÔ∏è PNG –≤ –∫–∞–Ω–∞–ª¬ª) –≤ `bot/handlers/render_pdf.py`.
2. –ò—Å—Ö–æ–¥–Ω–∏–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ —á–∞—Ç; –±–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∞–π–ª –≤ Redis (`store_blob`, –ø—Ä–µ—Ñ–∏–∫—Å—ã `pdf`, `doc`, `xls`, `png`).
3. –î–ª—è PDF/DOC/XLS –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–≤—å—é (`tasks.preview.generate_preview_task`), –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã/–ª–∏—Å—Ç/—Ç–∞–±–ª–∏—Ü—É, —É–∫–∞–∑–∞—Ç—å —Ç–µ–∫—Å—Ç –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é username –ø–æ–¥—Ä—è–¥—á–∏–∫–∞). –í–Ω—É—Ç—Ä–∏ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω—ã per-user `asyncio.Lock`, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–Ω–¥–µ—Ä–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
4. –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ç–∞–≤—è—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å Celery:
   - `tasks.render.process_and_publish_pdf|doc|excel` –∏–∑–≤–ª–µ–∫–∞—é—Ç —Ñ–∞–π–ª (–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º), —Ä–µ–Ω–¥–µ—Ä—è—Ç PNG 300 DPI, –Ω–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç watermark.
   - `tasks.render.process_and_publish_png` —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –≥–æ—Ç–æ–≤—ã–º–∏ PNG, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç DPI –∏ –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫.
5. `tasks.publish.send_document` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PNG –≤ –∫–∞–Ω–∞–ª –∫–∞–∫ `document` —Å `protect_content=True`, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ—Ç—Ä–∞—è –æ—à–∏–±–∫–∏ Telegram (403/429/400) –∏ –ª–æ–≥–∏—Ä—É—è –º–µ—Ç—Ä–∏–∫–∏.
6. `worker/tasks/render._record_publication` –∑–∞–Ω–æ—Å–∏—Ç –∑–∞–ø–∏—Å—å –æ —Å–æ–æ–±—â–µ–Ω–∏–∏ (—Ñ–∞–π–ª, caption, views) –≤ —Ç–∞–±–ª–∏—Ü—É `channel_files`; –¥–∞–ª–µ–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ú–æ–∏ –∫–∞–Ω–∞–ª—ã¬ª.

### –ò–Ω–≤–∞–π—Ç—ã –∏ –∑–∞—â–∏—Ç–∞ –¥–æ—Å—Ç—É–ø–∞
- –°–æ–∑–¥–∞–≤–∞–µ–º—ã–µ userbot‚Äô–æ–º –∫–∞–Ω–∞–ª—ã –≤—Å–µ–≥–¥–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç `ToggleNoForwardsRequest` –∏ `protected_content`.
- –í—Å–µ –≤—ã–¥–∞–≤–∞–µ–º—ã–µ —Å—Å—ã–ª–∫–∏ —á–µ—Ä–µ–∑ `create_chat_invite_link` –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã `member_limit=1`.
- `bot/services/projects.create_invite` —Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–∏–Ω—É –ø–æ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è–º; `bot/handlers/invite_manage.py` –≥–æ—Ç–æ–≤ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é TTL/–ª–∏–º–∏—Ç–∞–º–∏ —á–µ—Ä–µ–∑ backend (—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–æ–±–∞–≤—è—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –≤ FastAPI).
- –í –±–æ—Ç–µ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –∫–∞–∫ `document`; `render`-–ø–∞–π–ø–ª–∞–π–Ω –Ω–µ –¥–æ–ø—É—Å–∫–∞–µ—Ç –ø—Ä—è–º—ã—Ö —Ñ–æ—Ä–≤–∞—Ä–¥–æ–≤.

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å
- `channels_service.aggregate_contractor_stats` –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤/—Ñ–∞–π–ª–æ–≤/–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫.
- `channel_file_views` –∏ `channel_snapshots` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö; `worker/tasks/stats.py` –ø–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–≥–ª—É—à–∫—É `refresh_views_for_room`, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫ userbot –¥–ª—è —á—Ç–µ–Ω–∏—è `message.views`.
- –†–∞–±–æ—á–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —ç–∫—Å–ø–æ–Ω–∏—Ä—É–µ—Ç Prometheus-–º–µ—Ç—Ä–∏–∫–∏ (–ø–æ—Ä—Ç `METRICS_PORT`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 9464) –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∏ —Ä–µ—Ç—Ä–∞–µ–≤.
- Redis TTL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (`SOURCE_BLOB_TTL`/`FULLRES_BLOB_TTL`) –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.

## üóÉÔ∏è –•—Ä–∞–Ω–∏–ª–∏—â–∞ –∏ –¥–∞–Ω–Ω—ã–µ
- **PostgreSQL** (`infra/migrations`):
  - `projects`, `channels`, `project_invites`, `profiles` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞–º–∏ –ø–æ–¥—Ä—è–¥—á–∏–∫–∞.
  - `channel_files`, `channel_file_views`, `channel_snapshots`, `channel_members` ‚Äî –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.
  - –ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ —Ä–∞–Ω–Ω–∏—Ö –≤–µ—Ä—Å–∏–π (`rooms`, `documents`, `messages`, `invites`, `audits`, `plans`) —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏ –∞—É–¥–∏—Ç–∞.
- **Redis**:
  - –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã: `pdf:*`, `doc:*`, `xls:*`, `png:*`.
  - –ü–æ–ª–Ω—ã–µ PNG: `renderpng:*`.
  - –ü—Ä–µ–≤—å—é: `preview:*`.
  - –ö–ª—é—á–∏ —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (`_pop_storage_blob`, `delete_many`), —É–¥–µ—Ä–∂–∞–Ω–∏–µ —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç—Å—è TTL.
- **–î–∏—Å–∫ (`SESSIONS_DIR`)**: –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ Telethon-—Å–µ—Å—Å–∏–∏ `<contractor_id>.session.enc`.
- **Prometheus multiprocess dir** ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (`PROMETHEUS_MULTIPROC_DIR`) –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –º–µ—Ç—Ä–∏–∫ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–æ—Ä–∫–µ—Ä–∞—Ö.

## üîê –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- PDF –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ: –ø–æ—Å–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ PNG –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–µ–≤—å—é —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º TTL.
- –í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è —Å DPI 300 –∏ –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º (–µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π, watermark –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —è–≤–Ω–æ).
- –ü—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ—Å—É—â–µ—Å—Ç–≤–ª—è—é—Ç—Å—è –∫–∞–∫ `document` + `protect_content=True`; –∫–∞–Ω–∞–ª—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –≤—ã–∫–ª—é—á–µ–Ω–Ω—ã–º —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥–æ–º.
- –ö–∞–∂–¥–æ–º—É –ø–æ–¥—Ä—è–¥—á–∏–∫—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–∞—è MTProto-—Å–µ—Å—Å–∏—è; –∫–ª—é—á–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—é—Ç—Å—è `SESSION_SECRET`, —Ä–æ—Ç–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è.
- –°–µ–∫—Ä–µ—Ç—ã –∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `.env*`; –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–±–µ–≥–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–∫–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—à–∏–±–∫–∏, –Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç payload‚Äô—ã).
- –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–¥—Ä—è–¥—á–∏–∫–∞/–≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ø–∏—Å–∞—Ç—å –≤ `audits` (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç).

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- **Bot**: `BOT_TOKEN`, `BOT_USERNAME`, `DATABASE_URL`, `REDIS_URL`, `USERBOT_URL`, `WEBAPP_URL`, `CELERY_*`, `ENABLE_CELERY_PUBLISH`, `PREVIEW_TASK_TIMEOUT`, `SOURCE_BLOB_TTL`, `FULLRES_BLOB_TTL`, `ENV`/`APP_ENV`, `REQUIRE_INIT_DATA`, `TG_PROXY_URL`.
- **Worker**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ `REDIS_URL`/`CELERY_*`, –ø–ª—é—Å `WATERMARK_*`, `PREVIEW_BLOB_TTL`, `FULLRES_BLOB_PREFIX`, `METRICS_PORT`, `PUBLISH_STATS_INTERVAL`/`PUBLISH_STATS_SAMPLE`.
- **Userbot**: `API_ID`, `API_HASH`, `SESSION_SECRET`, `SESSIONS_DIR`, `BOT_USERNAME`, `USERBOT_FLOODWAIT_FALLBACK`.
- **Backend**: `WEBAPP_URL`, `BOT_TOKEN` (–¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞) ‚Äî –æ—Å—Ç–∞–ª—å–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–æ–±–∞–≤—è—Ç—Å—è –ø–æ–∑–∂–µ.
- **–í–Ω–µ—à–Ω–∏–µ –±–∏–Ω–∞—Ä–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: LibreOffice (`libreoffice`/`soffice`), Ghostscript (`gs`/`gswin64c`), –∞ —Ç–∞–∫–∂–µ Python-–ø–∞–∫–µ—Ç—ã PyMuPDF, Pillow, openpyxl, redis, asyncpg (—Å–º. `bot/requirements.txt`, `worker/requirements.txt`).
- Docker-–∫–æ–º–ø–æ—É–∑ (`docker-compose.yml` + overrides) –ø–æ–¥–Ω–∏–º–∞–µ—Ç PostgreSQL, Redis, backend, bot, userbot, worker.

## üöß –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ TODO
- Backend –ø–æ–∫–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ health-check –∏ –¥–µ–º–æ WebApp; REST-–∫–æ–Ω—Ç—Ä–∞–∫—Ç (contractors/projects/documents/invites) –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∏–∑ –±–æ—Ç–∞.
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (`worker/tasks/stats.refresh_views_for_room`) –µ—â—ë –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ userbot‚Äôa.
- –†–∞–∑–¥–µ–ª ¬´üîó –ú–æ–∏ —Å—Å—ã–ª–∫–∏¬ª –∏ `bot/handlers/invite_manage.py` –æ–∂–∏–¥–∞—é—Ç backend-—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ UI.
- –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∫–≤–æ—Ç—ã/—Ç–∞—Ä–∏—Ñ—ã (`plans`, `audits`, –ª–∏–º–∏—Ç—ã –ø–æ –ø–æ–¥–ø–∏—Å–∫–∞–º) ‚Äî —Ç–∞–±–ª–∏—Ü—ã –µ—Å—Ç—å, –Ω–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –æ—Ç–ª–æ–∂–µ–Ω–∞.
- –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –º–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ LibreOffice/Ghostscript –æ—à–∏–±–æ–∫ –≤ production.
