# 👤 SmetaBot — User Flow от Start

## 📋 Упрощённая схема потока пользователя и архитектуры

---

## 1. Полный User Flow от /start до публикации документа

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         НАЧАЛО: Пользователь нажимает /start                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         Handler: start.py                                   │
│                         ┌─────────────────────┐                             │
│                         │ Проверка сессии     │                             │
│                         │ GET /session/status│                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Userbot API]                                       │
│                         Endpoint: /session/status                            │
│                         ┌─────────────────────┐                             │
│                         │ Проверить файл      │                             │
│                         │ 123.session.enc     │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
        ┌───────────────────┐           ┌───────────────────┐
        │ Сессия НЕТ        │           │ Сессия ЕСТЬ       │
        └─────────┬─────────┘           └─────────┬─────────┘
                  │                               │
                  ▼                               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         Показать кнопку:                                    │
│                         "🔐 Подключить аккаунт (WebApp)"                   │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [WebApp]                                             │
│                         Страница: /webapp/login                             │
│                         ┌─────────────────────┐                             │
│                         │ Отобразить QR-код    │                             │
│                         │ POST /login/qr/start │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Userbot API]                                       │
│                         Endpoint: /login/qr/start                            │
│                         ┌─────────────────────┐                             │
│                         │ TelegramClient()     │                             │
│                         │ client.qr_login()    │                             │
│                         │ → QR-код (base64)    │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [WebApp]                                             │
│                         Показать QR-код пользователю                        │
│                         Polling: POST /login/qr/check                       │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Userbot API]                                       │
│                         Endpoint: /login/qr/check                            │
│                         ┌─────────────────────┐                             │
│                         │ Проверить статус    │                             │
│                         │ QR-логина           │                             │
│                         │ → authorized        │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [File System]                                        │
│                         Сохранить сессию:                                    │
│                         123.session.enc (зашифровано)                       │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [WebApp]                                             │
│                         tg.sendData({action: "session_ready"})              │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         Получить web_app_data                               │
│                         Проверить сессию: GET /session/status               │
│                         ┌─────────────────────┐                             │
│                         │ Создать/обновить     │                             │
│                         │ core.contractors     │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [PostgreSQL]                                         │
│                         INSERT/UPDATE core.contractors                      │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         Показать главное меню:                               │
│                         ┌─────────────────────┐                             │
│                         │ 🆕 Новый канал      │                             │
│                         │ 📄 Рендер файлов    │                             │
│                         │ 📢 Мои каналы       │                             │
│                         │ 👤 Личный кабинет   │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
        ┌───────────────────┐           ┌───────────────────┐
        │ Создать канал     │           │ Загрузить файл     │
        └─────────┬─────────┘           └─────────┬─────────┘
                  │                               │
                  ▼                               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         Handler: channel_wizard.py                           │
│                         FSM: waiting_title → waiting_avatar                 │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Userbot API]                                       │
│                         POST /rooms/create                                  │
│                         ┌─────────────────────┐                             │
│                         │ CreateChannelRequest │                             │
│                         │ ToggleNoForwards     │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram API]                                      │
│                         Создать канал                                       │
│                         Включить защиту                                     │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Userbot API]                                       │
│                         POST /rooms/add_bot_admin                            │
│                         Назначить бота администратором                      │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [PostgreSQL]                                         │
│                         INSERT INTO core.channels                            │
│                         UPDATE billing.usage_counters                        │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         create_chat_invite_link()                           │
│                         INSERT INTO core.invites                            │
│                         Показать ссылку пользователю                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. User Flow: Загрузка и публикация документа

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Пользователь выбирает "📄 Рендер файлов"            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         Handler: render_pdf.py                               │
│                         FSM: waiting_pdf                                    │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Пользователь загружает PDF                          │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         ┌─────────────────────┐                             │
│                         │ Сохранить в Redis    │                             │
│                         │ SET pdf:uuid-123     │                             │
│                         │ TTL: 86400 (24ч)     │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Redis]                                              │
│                         Key: pdf:uuid-123                                    │
│                         Value: [file_bytes]                                  │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         send_task("generate_preview_task")                  │
│                         Queue: "preview"                                     │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Celery Queue: preview]                             │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Worker Preview]                                     │
│                         ┌─────────────────────┐                             │
│                         │ GET pdf:uuid-123     │                             │
│                         │ PyMuPDF → PNG        │                             │
│                         │ Pillow → JPEG thumb  │                             │
│                         │ SET preview:uuid    │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         Показать превью пользователю                        │
│                         Выбор страниц: [1, 3, 5]                           │
│                         Водяной знак: "Иванов И.И."                         │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         send_task("process_and_publish_pdf")                 │
│                         Queue: "pdf"                                        │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Celery Queue: pdf]                                 │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Worker PDF]                                        │
│                         ┌─────────────────────┐                             │
│                         │ GET pdf:uuid-123     │                             │
│                         │ DEL pdf:uuid-123     │                             │
│                         │ PyMuPDF → PNG 300DPI │                             │
│                         │ apply_watermark()    │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Worker PDF]                                        │
│                         send_task("send_document")                            │
│                         Queue: "publish"                                     │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Celery Queue: publish]                              │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Worker Publish]                                    │
│                         ┌─────────────────────┐                             │
│                         │ Telegram Bot API     │                             │
│                         │ sendDocument()      │                             │
│                         │ protect_content=True │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram API]                                      │
│                         Отправить документ в канал                          │
│                         С защитой контента                                  │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Worker Publish]                                    │
│                         ┌─────────────────────┐                             │
│                         │ INSERT INTO          │                             │
│                         │ core.publications    │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [PostgreSQL]                                         │
│                         Сохранить метаданные публикации                      │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         ✅ Документ опубликован в канале                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Упрощённая архитектура компонентов

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬСКИЙ СЛОЙ                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│                         ┌──────────────┐                                    │
│                         │  Подрядчик   │                                    │
│                         │  (Telegram)   │                                    │
│                         └──────┬───────┘                                    │
│                                │                                             │
│                                │ Команды / Сообщения                         │
│                                │                                             │
└────────────────────────────────┼─────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         СЛОЙ ПРИЛОЖЕНИЙ                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│                         ┌──────────────────────┐                            │
│                         │   Telegram Bot        │                            │
│                         │   (aiogram)           │                            │
│                         │                       │                            │
│                         │  Handlers:            │                            │
│                         │  - start              │                            │
│                         │  - menu               │                            │
│                         │  - render_pdf         │                            │
│                         │  - channel_wizard     │                            │
│                         │                       │                            │
│                         │  Services:            │                            │
│                         │  - channels           │                            │
│                         │  - contractors       │                            │
│                         │  - billing            │                            │
│                         └───────┬───────────────┘                            │
│                                 │                                             │
│                                 │ HTTP / Tasks                                │
│                                 │                                             │
│                         ┌───────▼───────────────┐                            │
│                         │   Userbot API         │                            │
│                         │   (FastAPI)          │                            │
│                         │                       │                            │
│                         │  Endpoints:           │                            │
│                         │  - /session/status    │                            │
│                         │  - /login/qr/*        │                            │
│                         │  - /rooms/create      │                            │
│                         │  - /rooms/add_bot_admin│                            │
│                         └───────┬───────────────┘                            │
│                                 │                                             │
│                                 │ MTProto                                     │
│                                 │                                             │
│                         ┌───────▼───────────────┐                            │
│                         │   Telegram API        │                            │
│                         │   (MTProto)           │                            │
│                         └───────────────────────┘                            │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                 │
                                 │ Tasks
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         СЛОЙ ОБРАБОТКИ                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│                         ┌──────────────────────┐                            │
│                         │   Redis (Queue)       │                            │
│                         │                       │                            │
│                         │  Queues:              │                            │
│                         │  - pdf                │                            │
│                         │  - office             │                            │
│                         │  - publish            │                            │
│                         │  - preview            │                            │
│                         └───────┬───────────────┘                            │
│                                 │                                             │
│                                 │ Consume Tasks                               │
│                                 │                                             │
│         ┌───────────────────────┼───────────────────────┐                    │
│         │                       │                       │                    │
│         ▼                       ▼                       ▼                    │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐             │
│  │ Worker PDF   │      │Worker Office │      │Worker Publish│             │
│  │              │      │              │      │              │             │
│  │ PDF → PNG    │      │ DOC/XLS → PDF│      │ Send to      │             │
│  │ Watermark    │      │ → PNG        │      │ Channel      │             │
│  └──────┬───────┘      └──────┬───────┘      └──────┬───────┘             │
│         │                     │                      │                      │
│         └─────────────────────┼──────────────────────┘                      │
│                               │                                             │
│                               ▼                                             │
│                         ┌──────────────┐                                    │
│                         │Worker Preview│                                    │
│                         │              │                                    │
│                         │ Generate     │                                    │
│                         │ Thumbnails   │                                    │
│                         └──────────────┘                                    │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                 │
                                 │ Queries / Writes
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         СЛОЙ ХРАНИЛИЩА                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│         ┌──────────────────┐          ┌──────────────────┐                 │
│         │     Redis        │          │   PostgreSQL     │                 │
│         │                  │          │                  │                 │
│         │  - Queues        │          │  - core.*        │                 │
│         │  - Cache         │          │  - billing.*     │                 │
│         │  - Temp files    │          │  - analytics.*   │                 │
│         │                  │          │                  │                 │
│         │  Keys:           │          │  Tables:         │                 │
│         │  - pdf:uuid      │          │  - contractors   │                 │
│         │  - preview:uuid  │          │  - channels     │                 │
│         │  - renderpng:uuid│          │  - publications │                 │
│         └──────────────────┘          └──────────────────┘                 │
│                                                                               │
│         ┌──────────────────┐                                                 │
│         │  File System     │                                                 │
│         │                  │                                                 │
│         │  Sessions:       │                                                 │
│         │  - *.session.enc │                                                 │
│         │  (encrypted)     │                                                 │
│         └──────────────────┘                                                 │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Детальный поток: Создание канала

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Пользователь: "🆕 Новый канал"                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         Handler: channel_wizard.py                           │
│                         Проверка сессии: GET /session/status                │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
        ┌───────────────────┐           ┌───────────────────┐
        │ Сессия НЕТ        │           │ Сессия ЕСТЬ       │
        │ → Запросить       │           │ → Продолжить      │
        │   авторизацию     │           │                   │
        └───────────────────┘           └─────────┬─────────┘
                                                    │
                                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         FSM: waiting_title                                  │
│                         Запросить название канала                            │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Пользователь вводит: "Проект Иванова"               │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         FSM: waiting_avatar                                  │
│                         Запросить аватарку (опционально)                    │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
        ┌───────────────────┐           ┌───────────────────┐
        │ Пропустить         │           │ Загрузить фото     │
        └─────────┬─────────┘           └─────────┬─────────┘
                  │                               │
                  └───────────────┬───────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         Проверка лимитов:                                   │
│                         billing.can_create_channel()                         │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [PostgreSQL]                                         │
│                         Проверить billing.subscriptions                      │
│                         Проверить billing.usage_counters                     │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
        ┌───────────────────┐           ┌───────────────────┐
        │ Лимит превышен    │           │ Лимит OK          │
        │ → Ошибка          │           │ → Продолжить      │
        └───────────────────┘           └─────────┬─────────┘
                                                    │
                                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Userbot API]                                       │
│                         POST /rooms/create                                  │
│                         {contractor_id: "123", title: "Проект Иванова"}     │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Userbot API]                                       │
│                         Загрузить сессию: 123.session.enc                    │
│                         TelegramClient(StringSession)                        │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram API]                                      │
│                         CreateChannelRequest()                              │
│                         ToggleNoForwardsRequest(enabled=True)               │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Userbot API]                                       │
│                         POST /rooms/add_bot_admin                            │
│                         Назначить бота администратором                      │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram API]                                      │
│                         EditAdminRequest()                                  │
│                         Права: post_messages, invite_users                  │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         set_chat_photo() (если аватарка загружена)          │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [PostgreSQL]                                         │
│                         INSERT INTO core.channels                           │
│                         UPDATE billing.usage_counters                        │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         create_chat_invite_link()                           │
│                         INSERT INTO core.invites                            │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                      │
│                         ✅ Канал создан!                                    │
│                         Название: Проект Иванова                            │
│                         Ссылка: https://t.me/join/...                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Легенда компонентов

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ОБОЗНАЧЕНИЯ                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────┐  =  Компонент системы (сервис, API, хранилище)           │
│  │  [Component] │                                                           │
│  └──────────────┘                                                           │
│                                                                               │
│  ────→  =  Поток данных (HTTP, Tasks, Queries)                              │
│                                                                               │
│  ────┐  =  Разветвление (условие, выбор)                                     │
│  ────┘                                                                       │
│                                                                               │
│  ▼  =  Направление потока (вниз)                                             │
│                                                                               │
│  Пользователь  =  Действие пользователя (ввод, выбор)                       │
│                                                                               │
│  [Component]   =  Внутренний компонент системы                              │
│                                                                               │
│  ┌──────────┐  =  Условие или выбор                                          │
│  │ Условие  │                                                               │
│  └──────────┘                                                               │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Ключевые точки взаимодействия

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    КЛЮЧЕВЫЕ ТОЧКИ ВЗАИМОДЕЙСТВИЯ                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  1. Telegram Bot ↔ Userbot API                                              │
│     ──────────────────────────────────────────────────────────────         │
│     • Проверка сессии: GET /session/status                                  │
│     • Создание канала: POST /rooms/create                                    │
│     • Назначение админа: POST /rooms/add_bot_admin                           │
│                                                                               │
│  2. Telegram Bot ↔ Redis                                                    │
│     ──────────────────────────────────────────────────────────────         │
│     • Сохранение файлов: SET pdf:uuid [bytes]                               │
│     • Постановка задач: send_task()                                          │
│                                                                               │
│  3. Telegram Bot ↔ PostgreSQL                                               │
│     ──────────────────────────────────────────────────────────────         │
│     • Создание подрядчика: INSERT INTO core.contractors                      │
│     • Создание канала: INSERT INTO core.channels                            │
│     • Сохранение публикации: INSERT INTO core.publications                 │
│                                                                               │
│  4. Userbot API ↔ Telegram API                                              │
│     ──────────────────────────────────────────────────────────────         │
│     • QR-логин: client.qr_login()                                           │
│     • Создание канала: CreateChannelRequest()                                │
│     • Назначение админа: EditAdminRequest()                                  │
│                                                                               │
│  5. Workers ↔ Redis                                                         │
│     ──────────────────────────────────────────────────────────────         │
│     • Получение задач: consume from queue                                    │
│     • Чтение файлов: GET pdf:uuid                                            │
│     • Сохранение результатов: SET preview:uuid                               │
│                                                                               │
│  6. Workers ↔ PostgreSQL                                                    │
│     ──────────────────────────────────────────────────────────────         │
│     • Сохранение публикации: INSERT INTO core.publications                  │
│                                                                               │
│  7. Workers ↔ Telegram API                                                 │
│     ──────────────────────────────────────────────────────────────         │
│     • Публикация документа: sendDocument()                                  │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

**Версия документа:** 1.0  
**Дата создания:** 2024  
**Последнее обновление:** 2024

