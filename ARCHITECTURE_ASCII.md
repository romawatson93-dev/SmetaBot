# 🏗️ SmetaBot — ASCII-диаграммы архитектуры

## 📑 Содержание

1. [Общая архитектура системы](#1-общая-архитектура-системы)
2. [Слои приложения](#2-слои-приложения)
3. [Поток данных: Загрузка и публикация документа](#3-поток-данных-загрузка-и-публикация-документа)
4. [Процесс авторизации через QR-код](#4-процесс-авторизации-через-qr-код)
5. [Инфраструктура развёртывания](#5-инфраструктура-развёртывания)
6. [Очереди и воркеры](#6-очереди-и-воркеры)
7. [Взаимодействие компонентов](#7-взаимодействие-компонентов)
8. [Схема базы данных](#8-схема-базы-данных)

---

## 1. Общая архитектура системы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ВНЕШНИЙ СЛОЙ                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────┐                    ┌──────────────┐                       │
│  │  Подрядчик   │                    │   Клиент     │                       │
│  │  (Telegram)  │                    │  (Telegram)  │                       │
│  └──────┬───────┘                    └──────┬───────┘                       │
│         │                                    │                               │
│         │  Команды / Сообщения              │  Join Request                 │
│         │                                    │                               │
└─────────┼────────────────────────────────────┼───────────────────────────────┘
          │                                    │
          ▼                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        СЛОЙ ПРИЛОЖЕНИЙ                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Telegram Bot (aiogram)                        │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │   │
│  │  │  Handlers    │  │  Services    │  │   Storage    │             │   │
│  │  │  - start     │  │  - channels   │  │   - Redis    │             │   │
│  │  │  - menu      │  │  - contractors│  │   - Files    │             │   │
│  │  │  - render    │  │  - billing    │  │              │             │   │
│  │  │  - channels  │  │  - events     │  │              │             │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘             │   │
│  └─────────┼──────────────────┼──────────────────┼───────────────────────┘   │
│            │                  │                  │                            │
│            │ HTTP             │ Tasks            │ Queries                    │
│            │                  │                  │                            │
│  ┌─────────▼──────────────────▼──────────────────▼─────────────┐            │
│  │              Userbot API (FastAPI + Telethon)               │            │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │            │
│  │  │   Sessions   │  │   Channels   │  │   Telegram   │      │            │
│  │  │   - QR Login│  │   - Create   │  │   - MTProto  │      │            │
│  │  │   - Encrypt │  │   - Admin    │  │   - Views    │      │            │
│  │  │   - Storage │  │   - Photo    │  │   - Admins    │      │            │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │            │
│  └─────────┼──────────────────┼──────────────────┼─────────────┘            │
│            │                  │                  │                            │
│            │                  │                  │                            │
│  ┌─────────▼──────────────────▼──────────────────▼─────────────┐            │
│  │              Backend API (FastAPI)                          │            │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │            │
│  │  │   Health     │  │   WebApp     │  │   REST API   │      │            │
│  │  │   - /health  │  │   - /login   │  │   (planned)  │      │            │
│  │  └──────────────┘  └──────────────┘  └──────────────┘      │            │
│  └──────────────────────────────────────────────────────────────┘            │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        СЛОЙ ОБРАБОТКИ                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Celery Workers                                   │   │
│  │                                                                       │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │   │
│  │  │ Worker PDF   │  │Worker Office  │  │Worker Publish │             │   │
│  │  │ Queue: pdf  │  │ Queue: office│  │ Queue: publish│             │   │
│  │  │ Concurrency:3│ │ Concurrency:1│  │ Concurrency:2│             │   │
│  │  │              │  │              │  │              │             │   │
│  │  │ - PDF→PNG    │  │ - DOC→PDF    │  │ - Send to    │             │   │
│  │  │ - Watermark  │  │ - XLS→PDF    │  │   Channel    │             │   │
│  │  │              │  │ - LibreOffice│  │ - protect_   │             │   │
│  │  │              │  │              │  │   content    │             │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘             │   │
│  │         │                  │                  │                     │   │
│  │  ┌──────▼──────────────────▼──────────────────▼───────┐             │   │
│  │  │            Worker Preview                          │             │   │
│  │  │            Queue: preview                          │             │   │
│  │  │            Concurrency: 2                          │             │   │
│  │  │            - Generate thumbnails                   │             │   │
│  │  └────────────────────────────────────────────────────┘             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        СЛОЙ ХРАНИЛИЩА                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐         │
│  │     Redis        │  │   PostgreSQL     │  │  File System     │         │
│  │                  │  │                  │  │                  │         │
│  │  - Queues        │  │  - core.*        │  │  - Sessions      │         │
│  │  - Cache         │  │  - billing.*     │  │    (.enc files)  │         │
│  │  - Temp files    │  │  - analytics.*    │  │                  │         │
│  │                  │  │  - referrals.*   │  │                  │         │
│  │  Keys:           │  │  - admin.*       │  │                  │         │
│  │  - pdf:uuid      │  │                  │  │                  │         │
│  │  - doc:uuid      │  │  Tables:         │  │                  │         │
│  │  - preview:uuid  │  │  - contractors   │  │                  │         │
│  │  - renderpng:uuid│  │  - channels     │  │                  │         │
│  │                  │  │  - publications  │  │                  │         │
│  │  TTL:            │  │  - invites      │  │                  │         │
│  │  - Source: 24h   │  │  - clients      │  │                  │         │
│  │  - Preview: 1h   │  │  - subscriptions│  │                  │         │
│  │  - FullRes: 12h  │  │  - plans        │  │                  │         │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘         │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      ВНЕШНИЕ СЕРВИСЫ                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────┐  ┌──────────────────┐                                │
│  │  Telegram API    │  │  LibreOffice     │                                │
│  │                  │  │                  │                                │
│  │  - Bot API       │  │  - DOC→PDF       │                                │
│  │  - MTProto       │  │  - XLS→PDF       │                                │
│  │  - Channels      │  │  - Headless      │                                │
│  │  - Messages      │  │                  │                                │
│  └──────────────────┘  └──────────────────┘                                │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Слои приложения

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ПРЕЗЕНТАЦИОННЫЙ СЛОЙ                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Telegram Bot                                 │   │
│  │                                                                       │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │   │
│  │  │                    Handlers Layer                             │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │   │   │
│  │  │  │  start   │  │   menu   │  │  render  │  │ channels │     │   │   │
│  │  │  │  webapp  │  │  profile │  │  wizard  │  │  invites │     │   │   │
│  │  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘     │   │   │
│  │  └───────┼─────────────┼─────────────┼─────────────┼───────────┘   │   │
│  │          │             │             │             │               │   │
│  │  ┌───────▼─────────────▼─────────────▼─────────────▼───────────┐   │   │
│  │  │                    Services Layer                             │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │   │   │
│  │  │  │ channels │  │contractors│ │ billing  │  │  events  │     │   │   │
│  │  │  │  invites │  │  profiles │  │  usage   │  │  stats   │     │   │   │
│  │  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘     │   │   │
│  │  └───────┼─────────────┼─────────────┼─────────────┼───────────┘   │   │
│  │          │             │             │             │               │   │
│  │  ┌───────▼─────────────▼─────────────▼─────────────▼───────────┐   │   │
│  │  │                    Storage Layer                              │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │   │   │
│  │  │  │   Redis  │  │PostgreSQL│  │  Files   │                   │   │   │
│  │  │  │  (Queue) │  │   (DB)   │  │  (Temp)  │                   │   │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘                   │   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP / Tasks
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           БИЗНЕС-ЛОГИКА СЛОЙ                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Userbot API                                     │   │
│  │                                                                       │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │   │
│  │  │                    API Endpoints                               │   │   │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │   │   │
│  │  │  │ /session/*   │  │  /rooms/*     │  │  /login/*    │       │   │   │
│  │  │  │ /webapp/*    │  │  /views/*     │  │  /qr/*       │       │   │   │
│  │  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘       │   │   │
│  │  └─────────┼──────────────────┼──────────────────┼───────────────┘   │   │
│  │            │                  │                  │                    │   │
│  │  ┌─────────▼──────────────────▼──────────────────▼───────────────┐   │   │
│  │  │                    Telegram Operations                         │   │   │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │   │   │
│  │  │  │  Sessions    │  │   Channels    │  │   Messages   │       │   │   │
│  │  │  │  - QR Login  │  │  - Create    │  │  - Views     │       │   │   │
│  │  │  │  - Encrypt   │  │  - Admin     │  │  - Admins    │       │   │   │
│  │  │  │  - Storage   │  │  - Photo     │  │  - Stats     │       │   │   │
│  │  │  └──────────────┘  └──────────────┘  └──────────────┘       │   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Backend API                                    │   │
│  │                                                                       │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │   │
│  │  │   Health     │  │   WebApp     │  │   REST API   │             │   │
│  │  │   Endpoints  │  │   Pages      │  │   (planned)  │             │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                              │
                              │ Tasks
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           СЛОЙ ОБРАБОТКИ                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Celery Workers                                   │   │
│  │                                                                       │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │   │
│  │  │              Task Processing                                  │   │   │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │   │   │
│  │  │  │   Render     │  │   Preview    │  │   Publish    │       │   │   │
│  │  │  │   Tasks      │  │   Tasks      │  │   Tasks      │       │   │   │
│  │  │  │              │  │              │  │              │       │   │   │
│  │  │  │  - PDF→PNG   │  │  - Thumbnail │  │  - Send Doc  │       │   │   │
│  │  │  │  - DOC→PNG   │  │  - JPEG 1600 │  │  - Protect   │       │   │   │
│  │  │  │  - XLS→PNG   │  │  - Cache     │  │  - Record    │       │   │   │
│  │  │  │  - Watermark │  │              │  │              │       │   │   │
│  │  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘       │   │   │
│  │  └─────────┼──────────────────┼──────────────────┼───────────────┘   │   │
│  │            │                  │                  │                    │   │
│  │  ┌─────────▼──────────────────▼──────────────────▼───────────────┐   │   │
│  │  │              External Tools                                    │   │   │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │   │   │
│  │  │  │  PyMuPDF     │  │ LibreOffice  │  │  Pillow      │       │   │   │
│  │  │  │  (fitz)      │  │  (soffice)   │  │  (PIL)        │       │   │   │
│  │  │  │              │  │              │  │              │       │   │   │
│  │  │  │  PDF→PNG     │  │  DOC→PDF     │  │  Image Proc   │       │   │   │
│  │  │  │  300 DPI     │  │  XLS→PDF     │  │  Watermark    │       │   │   │
│  │  │  └──────────────┘  └──────────────┘  └──────────────┘       │   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Поток данных: Загрузка и публикация документа

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ЭТАП 1: ЗАГРУЗКА                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────┐                                                               │
│  │Подрядчик │                                                               │
│  └────┬─────┘                                                               │
│       │                                                                      │
│       │ 1. Загрузить PDF                                                    │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────┐                                                         │
│  │  Telegram Bot   │                                                         │
│  │  Handler:       │                                                         │
│  │  render_pdf.py  │                                                         │
│  └────┬────────────┘                                                         │
│       │                                                                      │
│       │ 2. Сохранить в Redis                                                │
│       │    Key: pdf:uuid-123                                                │
│       │    TTL: 86400 (24 часа)                                             │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────┐                                                         │
│  │     Redis       │                                                         │
│  │  pdf:uuid-123   │                                                         │
│  │  [file_bytes]   │                                                         │
│  └─────────────────┘                                                         │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                              │
                              │ 3. Поставить задачу
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ЭТАП 2: ГЕНЕРАЦИЯ ПРЕВЬЮ                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              Celery Queue: preview                                   │   │
│  └────────────────────────────┬────────────────────────────────────────┘   │
│                                │                                             │
│                                │ 4. Забрать задачу                           │
│                                ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │            Worker Preview                                            │   │
│  │                                                                       │   │
│  │  5. GET pdf:uuid-123 из Redis                                        │   │
│  │  6. PyMuPDF: PDF → PNG (300 DPI)                                     │   │
│  │  7. Pillow: PNG → JPEG thumbnail (1600px)                            │   │
│  │  8. SET preview:uuid-123 [thumbnail] TTL: 3600                       │   │
│  └────────────────────────────┬────────────────────────────────────────┘   │
│                                │                                             │
│                                │ 9. Превью готово                            │
│                                ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              Telegram Bot                                            │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │   │
│  │  │  Показать превью пользователю                                 │   │   │
│  │  │  - Выбор страниц: [1, 3, 5]                                   │   │   │
│  │  │  - Водяной знак: "Иванов И.И."                                │   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                              │
                              │ 10. Поставить задачу рендеринга
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ЭТАП 3: РЕНДЕРИНГ                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              Celery Queue: pdf                                      │   │
│  └────────────────────────────┬────────────────────────────────────────┘   │
│                                │                                             │
│                                │ 11. Забрать задачу                           │
│                                ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │            Worker PDF                                               │   │
│  │                                                                       │   │
│  │  12. GET pdf:uuid-123 из Redis                                       │   │
│  │  13. DEL pdf:uuid-123 (однократное чтение)                           │   │
│  │  14. PyMuPDF: PDF → PNG 300 DPI для страниц [1,3,5]                 │   │
│  │                                                                       │   │
│  │      ┌───────────────────────────────────────────────────────┐      │   │
│  │      │  Для каждой страницы:                                 │      │   │
│  │      │  15. apply_tiled_watermark(png, "Иванов И.И.")        │      │   │
│  │      │  16. SET renderpng:uuid-page [watermarked_png]         │      │   │
│  │      └───────────────────────────────────────────────────────┘      │   │
│  └────────────────────────────┬────────────────────────────────────────┘   │
│                                │                                             │
│                                │ 17. Поставить задачи публикации              │
│                                ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              Celery Queue: publish                                  │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                              │
                              │ 18. Забрать задачи
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ЭТАП 4: ПУБЛИКАЦИЯ                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │            Worker Publish                                            │   │
│  │                                                                       │   │
│  │  19. GET renderpng:uuid-page из Redis                                │   │
│  │  20. Telegram Bot API: sendDocument(                                 │   │
│  │        chat_id,                                                       │   │
│  │        document=renderpng_bytes,                                     │   │
│  │        filename="smeta-page-01.png",                                 │   │
│  │        protect_content=True  ← ЗАЩИТА                                │   │
│  │      )                                                                │   │
│  │                                                                       │   │
│  │  21. Получить message_id от Telegram                                  │   │
│  │                                                                       │   │
│  │  22. INSERT INTO core.publications (                                  │   │
│  │        channel_id,                                                     │   │
│  │        message_id,                                                     │   │
│  │        file_name,                                                      │   │
│  │        file_type="image/png",                                          │   │
│  │        views=0                                                         │   │
│  │      )                                                                 │   │
│  │                                                                       │   │
│  │  23. DELETE renderpng:uuid-page из Redis                             │   │
│  └────────────────────────────┬────────────────────────────────────────┘   │
│                                │                                             │
│                                │ 24. Успешно опубликовано                    │
│                                ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              Telegram Bot                                            │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │   │
│  │  │  ✅ Документ опубликован в канале                             │   │   │
│  │  │  ✅ 3 страницы отправлены                                      │   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                              │
                              │ 25. Уведомить пользователя
                              ▼
                        ┌──────────┐
                        │Подрядчик │
                        └──────────┘
```

---

## 4. Процесс авторизации через QR-код

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      ПРОЦЕСС АВТОРИЗАЦИИ ЧЕРЕЗ QR-КОД                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────┐                                                               │
│  │Подрядчик │                                                               │
│  └────┬─────┘                                                               │
│       │                                                                      │
│       │ 1. /start или кнопка "Подключить аккаунт"                          │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────┐                                                         │
│  │  Telegram Bot   │                                                         │
│  │                 │                                                         │
│  │  2. GET /session/status?contractor_id=123                                 │
│  │     → {has_session: false}                                                │
│  │                                                                           │
│  │  3. Показать кнопку "🔐 Открыть WebApp"                                  │
│  └────┬────────────┘                                                         │
│       │                                                                      │
│       │ 4. Пользователь открывает WebApp                                    │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    WebApp (HTML/JS)                                 │   │
│  │                                                                       │   │
│  │  5. GET /session/status?contractor_id=123&verify=true                │   │
│  │     → {has_session: false}                                           │   │
│  │                                                                       │   │
│  │  6. POST /login/qr/start {contractor_id: "123"}                     │   │
│  └────┬────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       │ 7. HTTP Request                                                    │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                  Userbot API                                        │   │
│  │                                                                       │   │
│  │  8. TelegramClient(StringSession())                                 │   │
│  │  9. client.qr_login()                                                │   │
│  │     → QR-код (base64)                                                │   │
│  │                                                                       │   │
│  │  10. Сохранить в _pending_qr[token] = {                             │   │
│  │        client: TelegramClient,                                       │   │
│  │        contractor_id: "123",                                          │   │
│  │        qr_code: "data:image/png;base64,..."                          │   │
│  │      }                                                                │   │
│  │                                                                       │   │
│  │  11. Return {token: "abc123", qr_code: "base64..."}                  │   │
│  └────┬────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       │ 12. Response                                                       │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    WebApp                                           │   │
│  │                                                                       │   │
│  │  13. Отобразить QR-код                                               │   │
│  │  14. Инструкция: "Откройте Telegram Desktop/Web                      │   │
│  │       и отсканируйте QR-код"                                         │   │
│  │                                                                       │   │
│  │  15. Polling каждые 2 секунды:                                       │   │
│  │      POST /login/qr/check {token: "abc123"}                          │   │
│  └────┬────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       │ 16. HTTP Request (polling)                                         │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                  Userbot API                                        │   │
│  │                                                                       │   │
│  │  17. Проверить статус QR-логина:                                     │   │
│  │      client.qr_login() → status                                     │   │
│  │                                                                       │   │
│  │      ┌───────────────────────────────────────────────────────┐      │   │
│  │      │  Статус: waiting                                      │      │   │
│  │      │  → Return {status: "waiting"}                        │      │   │
│  │      │  → WebApp продолжает polling                         │      │   │
│  │      └───────────────────────────────────────────────────────┘      │   │
│  │                                                                       │   │
│  │      ┌───────────────────────────────────────────────────────┐      │   │
│  │      │  Статус: waiting_for_password (2FA)                  │      │   │
│  │      │  → Return {status: "2fa_required"}                   │      │   │
│  │      │  → WebApp запрашивает пароль                          │      │   │
│  │      └───────────────────────────────────────────────────────┘      │   │
│  │                                                                       │   │
│  │      ┌───────────────────────────────────────────────────────┐      │   │
│  │      │  Статус: authorized                                    │      │   │
│  │      │  → Сохранить StringSession                            │      │   │
│  │      │  → Зашифровать Fernet(SESSION_SECRET)                │      │   │
│  │      │  → Сохранить в файл: 123.session.enc                  │      │   │
│  │      │  → Return {status: "ready", me: {...}}                │      │   │
│  │      └───────────────────────────────────────────────────────┘      │   │
│  └────┬────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       │ 18. Response                                                        │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    WebApp                                           │   │
│  │                                                                       │   │
│  │  19. Если status == "ready":                                         │   │
│  │      - tg.sendData({action: "session_ready"})                      │   │
│  │      - Показать "✅ Аккаунт подключён"                             │   │
│  │                                                                       │   │
│  │  20. Если status == "2fa_required":                                 │   │
│  │      - Показать поле ввода пароля                                   │   │
│  │      - POST /login/qr/2fa {token, password}                        │   │
│  └────┬────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       │ 21. WebApp Data                                                    │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                  Telegram Bot                                        │   │
│  │                                                                       │   │
│  │  22. Получить web_app_data: {action: "session_ready"}                │   │
│  │  23. GET /session/status?contractor_id=123&verify=true                │   │
│  │     → {has_session: true, authorized: true}                           │   │
│  │                                                                       │   │
│  │  24. Создать/обновить запись в core.contractors                      │   │
│  │  25. Показать главное меню с разблокированными функциями             │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Инфраструктура развёртывания

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DOCKER COMPOSE ARCHITECTURE                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Reverse Proxy Layer                             │   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    Traefik                                    │   │   │
│  │  │  Ports: 80, 443                                                │   │   │
│  │  │  SSL: Let's Encrypt                                            │   │   │
│  │  │  Routes:                                                       │   │   │
│  │  │    - userbot → orbitsend.ru                                    │   │   │
│  │  │    - backend → (internal)                                      │   │   │
│  │  └───────────────┬───────────────────────────────────────────────┘   │   │
│  └──────────────────┼───────────────────────────────────────────────────┘   │
│                     │                                                         │
│                     │ HTTPS                                                   │
│                     │                                                         │
│  ┌──────────────────▼───────────────────────────────────────────────────┐   │
│  │                    Application Layer                                 │   │
│  │                                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │   │
│  │  │   Backend    │  │   Userbot    │  │     Bot      │                │   │
│  │  │              │  │              │  │              │                │   │
│  │  │  Port: 8000  │  │  Port: 8001  │  │  Polling     │                │   │
│  │  │  Health:     │  │  Health:     │  │  (no port)   │                │   │
│  │  │  /health     │  │  /health     │  │              │                │   │
│  │  │              │  │              │  │              │                │   │
│  │  │  - FastAPI   │  │  - FastAPI   │  │  - aiogram  │                │   │
│  │  │  - REST API  │  │  - Telethon  │  │  - Handlers │                │   │
│  │  │  - WebApp    │  │  - QR Login  │  │  - Services │                │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                │   │
│  └─────────┼──────────────────┼──────────────────┼────────────────────────┘   │
│            │                  │                  │                             │
│            │ HTTP             │ HTTP             │ Tasks                       │
│            │                  │                  │                             │
│  ┌─────────▼──────────────────▼──────────────────▼─────────────────────────┐
│  │                    Worker Layer                                            │
│  │                                                                             │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │  │ Worker PDF   │  │Worker Office │  │Worker Publish │                  │
│  │  │              │  │              │  │              │                  │
│  │  │ Queue: pdf   │  │ Queue: office│  │ Queue: publish│                  │
│  │  │ Concurrency:3│  │ Concurrency:1│  │ Concurrency:2 │                  │
│  │  │ Metrics:9464│  │ Metrics:9466 │  │ Metrics:9465  │                  │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                  │
│  │         │                  │                  │                            │
│  │  ┌──────▼──────────────────▼──────────────────▼───────┐                  │
│  │  │            Worker Preview                          │                  │
│  │  │            Queue: preview                          │                  │
│  │  │            Concurrency: 2                         │                  │
│  │  │            Metrics: 9467                          │                  │
│  │  └────────────────────────────────────────────────────┘                  │
│  └──────────────────────────────────────────────────────────────────────────┘
│            │                  │                  │
│            │ Tasks             │ Tasks             │ Tasks
│            │                  │                  │
│  ┌─────────▼──────────────────▼──────────────────▼─────────────────────────┐
│  │                    Storage Layer                                          │
│  │                                                                             │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │  │    Redis     │  │  PostgreSQL  │  │ File System  │                  │
│  │  │              │  │              │  │              │                  │
│  │  │  Port: 6379  │  │  Port: 5432  │  │  Volume:     │                  │
│  │  │              │  │              │  │  sessions/   │                  │
│  │  │  - Queues    │  │  - core.*     │  │              │                  │
│  │  │  - Cache     │  │  - billing.*  │  │  *.enc files │                  │
│  │  │  - Temp files│  │  - analytics.*│ │              │                  │
│  │  │              │  │  - referrals.*│ │              │                  │
│  │  │  Volume:     │  │  - admin.*    │  │              │                  │
│  │  │  (in-memory) │  │              │  │              │                  │
│  │  │              │  │  Volume:      │  │              │                  │
│  │  │              │  │  pgdata       │  │              │                  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                  │
│  └──────────────────────────────────────────────────────────────────────────┘
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Monitoring                                        │   │
│  │                                                                       │   │
│  │  ┌──────────────┐                                                   │   │
│  │  │    Flower    │                                                   │   │
│  │  │              │                                                   │   │
│  │  │  Port: 5555  │                                                   │   │
│  │  │  - Celery    │                                                   │   │
│  │  │    Monitor   │                                                   │   │
│  │  │  - Tasks     │                                                   │   │
│  │  │  - Workers   │                                                   │   │
│  │  └──────────────┘                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Очереди и воркеры

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CELERY QUEUES AND WORKERS                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Task Producers                                    │   │
│  │                                                                       │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │   │
│  │  │ Telegram Bot │  │  Backend API │  │  Scheduled   │             │   │
│  │  │              │  │              │  │  Tasks       │             │   │
│  │  │  - Upload    │  │  - API calls │  │  - Stats     │             │   │
│  │  │  - Render    │  │  - Webhooks │  │  - Cleanup   │             │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘             │   │
│  └─────────┼──────────────────┼──────────────────┼───────────────────────┘   │
│            │                  │                  │                            │
│            │ send_task        │ send_task        │ send_task                  │
│            │                  │                  │                            │
│  ┌─────────▼──────────────────▼──────────────────▼─────────────────────────┐
│  │                    Redis Broker                                           │
│  │                                                                             │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │  │ Queue: pdf   │  │ Queue: office│  │ Queue: publish│                  │
│  │  │              │  │              │  │              │                  │
│  │  │  Tasks:      │  │  Tasks:      │  │  Tasks:      │                  │
│  │  │  - process_  │  │  - process_  │  │  - send_     │                  │
│  │  │    and_      │  │    and_      │  │    document  │                  │
│  │  │    publish_  │  │    publish_  │  │              │                  │
│  │  │    pdf       │  │    doc       │  │              │                  │
│  │  │              │  │  - process_  │  │              │                  │
│  │  │              │  │    and_      │  │              │                  │
│  │  │              │  │    publish_  │  │              │                  │
│  │  │              │  │    excel     │  │              │                  │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                  │
│  │         │                  │                  │                            │
│  │  ┌──────▼──────────────────▼──────────────────▼───────┐                  │
│  │  │            Queue: preview                            │                  │
│  │  │            Tasks:                                   │                  │
│  │  │            - generate_preview_task                  │                  │
│  │  └────────────────────────────────────────────────────┘                  │
│  └──────────────────────────────────────────────────────────────────────────┘
│            │                  │                  │                  │
│            │ consume          │ consume          │ consume          │ consume
│            │                  │                  │                  │
│  ┌─────────▼──────────────────▼──────────────────▼──────────────────▼──────┐
│  │                    Workers                                                │
│  │                                                                             │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐  │
│  │  │ Worker PDF   │  │Worker Office │  │Worker Publish │  │Preview   │  │
│  │  │              │  │              │  │              │  │Worker    │  │
│  │  │ Concurrency:3│  │ Concurrency:1│  │ Concurrency:2 │  │Concur:2  │  │
│  │  │              │  │              │  │              │  │          │  │
│  │  │ Process:     │  │ Process:     │  │ Process:     │  │ Process: │  │
│  │  │ - PDF→PNG    │  │ - DOC→PDF    │  │ - Get PNG    │  │ - PDF→   │  │
│  │  │ - Watermark  │  │ - XLS→PDF    │  │ - Send to    │  │   Thumb  │  │
│  │  │ - Queue to   │  │ - PDF→PNG    │  │   Channel    │  │ - Cache  │  │
│  │  │   publish    │  │ - Watermark  │  │ - Record DB  │  │          │  │
│  │  │              │  │ - Queue to   │  │ - Delete temp│  │          │  │
│  │  │              │  │   publish    │  │              │  │          │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────┘  │
│  └──────────────────────────────────────────────────────────────────────────┘
│            │                  │                  │                  │
│            │ Result           │ Result           │ Result           │ Result
│            │                  │                  │                  │
│  ┌─────────▼──────────────────▼──────────────────▼──────────────────▼──────┐
│  │                    Result Backend (Redis)                                 │
│  │                                                                             │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐  │
│  │  │ Task Results│  │ Task Results │  │ Task Results │  │Task      │  │
│  │  │ (PDF)       │  │ (Office)     │  │ (Publish)    │  │Results   │  │
│  │  │             │  │              │  │              │  │(Preview) │  │
│  │  │ TTL: 1h     │  │ TTL: 1h      │  │ TTL: 1h      │  │TTL: 1h   │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────┘  │
│  └──────────────────────────────────────────────────────────────────────────┘
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Взаимодействие компонентов

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    COMPONENT INTERACTION FLOW                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────┐                                                               │
│  │Подрядчик │                                                               │
│  └────┬─────┘                                                               │
│       │                                                                      │
│       │ [1] Команда /start                                                   │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              Telegram Bot (aiogram)                                  │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │   │
│  │  │  Handler: start.py                                             │   │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │   │
│  │  │  │  Service: contractors.py                                │   │   │   │
│  │  │  │  ┌───────────────────────────────────────────────────┐   │   │   │   │
│  │  │  │  │  DB: PostgreSQL                                   │   │   │   │   │
│  │  │  │  │  SELECT * FROM core.contractors                   │   │   │   │   │
│  │  │  │  │  WHERE tg_user_id = 123                           │   │   │   │   │
│  │  │  │  └───────────────────────────────────────────────────┘   │   │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │   │
│  │  │  │  HTTP: Userbot API                                      │   │   │   │
│  │  │  │  GET /session/status?contractor_id=123                  │   │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │   │
│  └────┬───────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       │ [2] HTTP Request                                                     │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              Userbot API (FastAPI)                                  │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │
│  │  │  Endpoint: /session/status                                      │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  │  Load session from file: 123.session.enc                 │   │   │
│  │  │  │  Decrypt with Fernet(SESSION_SECRET)                     │   │   │
│  │  │  │  Check if authorized                                     │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  │  Return: {has_session: true, authorized: true}                  │   │
│  │  └───────────────────────────────────────────────────────────────┘   │
│  └────┬───────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       │ [3] HTTP Response                                                    │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              Telegram Bot                                            │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │
│  │  │  Show main menu with unlocked features                         │   │
│  │  │  - 🆕 Новый канал                                              │   │
│  │  │  - 📄 Рендер файлов                                            │   │
│  │  │  - 📢 Мои каналы                                               │   │
│  │  └───────────────────────────────────────────────────────────────┘   │
│  └────┬───────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       │ [4] User uploads PDF                                                │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              Telegram Bot                                            │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │
│  │  │  Handler: render_pdf.py                                        │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  │  Storage: Redis                                         │   │   │
│  │  │  │  SET pdf:uuid-123 [file_bytes] EX 86400                 │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  │  Celery: send_task                                     │   │   │
│  │  │  │  tasks.preview.generate_preview_task                    │   │   │
│  │  │  │  queue="preview"                                       │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │
│  └────┬───────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       │ [5] Task in Queue                                                   │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              Worker Preview                                         │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │
│  │  │  Get task from queue: preview                                 │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  │  Redis: GET pdf:uuid-123                               │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  │  PyMuPDF: PDF → PNG (300 DPI)                           │   │   │
│  │  │  │  Pillow: PNG → JPEG thumbnail (1600px)                  │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  │  Redis: SET preview:uuid-123 [thumbnail] EX 3600        │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │
│  └────┬───────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       │ [6] Preview ready                                                    │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              Telegram Bot                                            │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │
│  │  │  Show preview to user                                          │   │
│  │  │  User selects pages: [1, 3, 5]                                 │   │
│  │  │  User enters watermark: "Иванов И.И."                         │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  │  Celery: send_task                                     │   │   │
│  │  │  │  tasks.render.process_and_publish_pdf                    │   │   │
│  │  │  │  queue="pdf"                                            │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │
│  └────┬───────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       │ [7] Task in Queue                                                   │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              Worker PDF                                             │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │
│  │  │  Get task from queue: pdf                                      │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  │  Redis: GET pdf:uuid-123                               │   │   │
│  │  │  │  Redis: DEL pdf:uuid-123                                │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  │  PyMuPDF: PDF → PNG 300 DPI (pages [1,3,5])           │   │   │
│  │  │  │  Watermark: apply_tiled_watermark("Иванов И.И.")       │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  │  Celery: send_task                                     │   │   │
│  │  │  │  tasks.publish.send_document                            │   │   │
│  │  │  │  queue="publish"                                       │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │
│  └────┬───────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       │ [8] Task in Queue                                                   │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │              Worker Publish                                          │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │
│  │  │  Get task from queue: publish                                  │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  │  Telegram Bot API: sendDocument                         │   │   │
│  │  │  │  chat_id, document, protect_content=True                 │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  │  DB: PostgreSQL                                        │   │   │
│  │  │  │  INSERT INTO core.publications                          │   │   │
│  │  │  │  (channel_id, message_id, file_name, views)            │   │   │
│  │  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │
│  └────┬───────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       │ [9] Success                                                          │
│       │                                                                      │
│       ▼                                                                      │
│  ┌──────────┐                                                               │
│  │Подрядчик │                                                               │
│  │  ✅ Документ опубликован                                                │
│  └──────────┘                                                               │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Схема базы данных

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DATABASE SCHEMA                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    SCHEMA: core                                      │   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  contractors                                                 │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │   │
│  │  │  │ id (PK)  │  │tg_user_id│  │ username │  │full_name │   │   │   │
│  │  │  │ status   │  │(UNIQUE)  │  │          │  │          │   │   │   │
│  │  │  │created_at│  │          │  │          │  │          │   │   │   │
│  │  │  └────┬─────┘  └──────────┘  └──────────┘  └──────────┘   │   │   │
│  │  │       │                                                      │   │   │
│  │  │       │ 1:N                                                   │   │   │
│  │  │       │                                                       │   │   │
│  │  │       ▼                                                       │   │   │
│  │  │  ┌───────────────────────────────────────────────────────┐   │   │   │
│  │  │  │  channels                                              │   │   │   │
│  │  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │   │   │
│  │  │  │  │ id (PK)  │  │contractor│  │tg_chat_id│          │   │   │   │
│  │  │  │  │          │  │_id (FK)   │  │(UNIQUE)   │          │   │   │   │
│  │  │  │  │ title    │  │          │  │          │          │   │   │   │
│  │  │  │  │ username │  │          │  │          │          │   │   │   │
│  │  │  │  │created_at│  │          │  │          │          │   │   │   │
│  │  │  │  └────┬─────┘  └──────────┘  └──────────┘          │   │   │   │
│  │  │  │       │                                                      │   │   │
│  │  │  │       │ 1:N                                                   │   │   │
│  │  │  │       │                                                       │   │   │
│  │  │  │       ▼                                                       │   │   │
│  │  │  │  ┌───────────────────────────────────────────────────────┐   │   │   │
│  │  │  │  │  publications                                          │   │   │   │
│  │  │  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │   │   │
│  │  │  │  │  │ id (PK)  │  │channel_id│  │message_id│          │   │   │   │
│  │  │  │  │  │          │  │(FK)      │  │          │          │   │   │   │
│  │  │  │  │  │file_name │  │          │  │(UNIQUE   │          │   │   │   │
│  │  │  │  │  │file_type │  │          │  │ with     │          │   │   │   │
│  │  │  │  │  │ views    │  │          │  │channel)  │          │   │   │   │
│  │  │  │  │  │posted_at │  │          │  │          │          │   │   │   │
│  │  │  │  │  │ deleted  │  │          │  │          │          │   │   │   │
│  │  │  │  │  └──────────┘  └──────────┘  └──────────┘          │   │   │   │
│  │  │  │  └───────────────────────────────────────────────────────┘   │   │   │
│  │  │  │                                                               │   │   │
│  │  │  │       │ 1:N                                                   │   │   │
│  │  │  │       │                                                       │   │   │
│  │  │  │       ▼                                                       │   │   │
│  │  │  │  ┌───────────────────────────────────────────────────────┐   │   │   │
│  │  │  │  │  invites                                               │   │   │   │
│  │  │  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │   │   │
│  │  │  │  │  │ id (PK)  │  │channel_id│  │  token   │          │   │   │   │
│  │  │  │  │  │          │  │(FK)      │  │(UNIQUE)   │          │   │   │   │
│  │  │  │  │  │expires_at│  │          │  │          │          │   │   │   │
│  │  │  │  │  │ max_uses │  │          │  │          │          │   │   │   │
│  │  │  │  │  │used_count│  │          │  │          │          │   │   │   │
│  │  │  │  │  │created_at│  │          │  │          │          │   │   │   │
│  │  │  │  │  └──────────┘  └──────────┘  └──────────┘          │   │   │   │
│  │  │  │  └───────────────────────────────────────────────────────┘   │   │   │
│  │  │  │                                                               │   │   │
│  │  │  │       │ 1:N                                                   │   │   │
│  │  │  │       │                                                       │   │   │
│  │  │  │       ▼                                                       │   │   │
│  │  │  │  ┌───────────────────────────────────────────────────────┐   │   │   │
│  │  │  │  │  clients                                               │   │   │   │
│  │  │  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │   │   │
│  │  │  │  │  │ id (PK)  │  │channel_id│  │invite_id │          │   │   │   │
│  │  │  │  │  │          │  │(FK)      │  │(FK)      │          │   │   │   │
│  │  │  │  │  │tg_user_id│  │          │  │          │          │   │   │   │
│  │  │  │  │  │ username │  │          │  │          │          │   │   │   │
│  │  │  │  │  │full_name │  │          │  │          │          │   │   │   │
│  │  │  │  │  │joined_at │  │          │  │          │          │   │   │   │
│  │  │  │  │  │ blocked  │  │          │  │          │          │   │   │   │
│  │  │  │  │  └──────────┘  └──────────┘  └──────────┘          │   │   │   │
│  │  │  │  └───────────────────────────────────────────────────────┘   │   │   │
│  │  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │  └─────────────────────────────────────────────────────────────────────┘   │
│  │                                                                             │
│  └───────────────────────────────────────────────────────────────────────────┘
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    SCHEMA: billing                                    │   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  plans                                                       │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │   │
│  │  │  │ id (PK)  │  │ code     │  │  name    │  │price_month│  │   │   │
│  │  │  │          │  │(UNIQUE)  │  │          │  │          │   │   │   │
│  │  │  │features  │  │          │  │          │  │          │   │   │   │
│  │  │  │(JSONB)   │  │          │  │          │  │          │   │   │   │
│  │  │  └────┬─────┘  └──────────┘  └──────────┘  └──────────┘   │   │   │
│  │  │       │                                                      │   │   │
│  │  │       │ 1:N                                                   │   │   │
│  │  │       │                                                       │   │   │
│  │  │       ▼                                                       │   │   │
│  │  │  ┌───────────────────────────────────────────────────────┐   │   │   │
│  │  │  │  subscriptions                                         │   │   │   │
│  │  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │   │   │
│  │  │  │  │ id (PK)  │  │contractor│  │ plan_id  │          │   │   │   │
│  │  │  │  │          │  │_id (FK,  │  │(FK)      │          │   │   │   │
│  │  │  │  │ status   │  │ UNIQUE)  │  │          │          │   │   │   │
│  │  │  │  │starts_at │  │          │  │          │          │   │   │   │
│  │  │  │  │expires_at│  │          │  │          │          │   │   │   │
│  │  │  │  │ source   │  │          │  │          │          │   │   │   │
│  │  │  │  └──────────┘  └──────────┘  └──────────┘          │   │   │   │
│  │  │  └───────────────────────────────────────────────────────┘   │   │   │
│  │  │                                                               │   │   │
│  │  │  ┌───────────────────────────────────────────────────────┐   │   │   │
│  │  │  │  usage_counters                                        │   │   │   │
│  │  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │   │   │
│  │  │  │  │contractor│  │channels_ │  │last_     │          │   │   │   │
│  │  │  │  │_id (PK, │  │created_  │  │channel_  │          │   │   │   │
│  │  │  │  │ FK)      │  │total     │  │created_at│          │   │   │   │
│  │  │  │  └──────────┘  └──────────┘  └──────────┘          │   │   │   │
│  │  │  └───────────────────────────────────────────────────────┘   │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    SCHEMA: analytics                                  │   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  views_daily                                                  │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                 │   │   │
│  │  │  │publication│  │collected_│  │  views   │                 │   │   │
│  │  │  │_id (PK,  │  │at (PK)   │  │          │                 │   │   │
│  │  │  │ FK)      │  │          │  │          │                 │   │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘                 │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  channel_stats                                               │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │   │
│  │  │  │channel_id│  │files_    │  │views_    │  │clients_  │   │   │   │
│  │  │  │(PK, FK)  │  │count     │  │total     │  │total     │   │   │   │
│  │  │  │          │  │          │  │          │  │          │   │   │   │
│  │  │  │last_     │  │          │  │          │  │          │   │   │   │
│  │  │  │updated   │  │          │  │          │  │          │   │   │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

**Версия документа:** 1.0  
**Дата создания:** 2024  
**Последнее обновление:** 2024

