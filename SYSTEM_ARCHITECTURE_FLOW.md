# 🏗️ SmetaBot — High-Level System Architecture Flow

## 📋 Описание

Данный документ содержит высокоуровневую архитектурную диаграмму системы, показывающую полный путь от момента нажатия пользователем кнопки Start в Telegram до получения им результата.

**Фокус:** Только логика взаимодействия компонентов, без деталей реализации.

---

## 🔄 Полный поток: от Start до результата

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    НАЧАЛО: Пользователь нажимает /start                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                       │
│                         Handler: /start                                     │
│                         ┌─────────────────────┐                             │
│                         │ Проверка сессии      │                             │
│                         │ GET /session/status │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Userbot API]                                        │
│                         Проверка наличия сессии                              │
│                         ┌─────────────────────┐                             │
│                         │ Файл сессии существует?│                          │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
        ┌───────────────────┐           ┌───────────────────┐
        │ Сессия НЕТ        │           │ Сессия ЕСТЬ      │
        └─────────┬─────────┘           └─────────┬─────────┘
                  │                               │
                  ▼                               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                       │
│                         Показать WebApp для авторизации                     │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [WebApp]                                             │
│                         QR-код авторизация                                   │
│                         ┌─────────────────────┐                             │
│                         │ POST /login/qr/start│                             │
│                         │ POST /login/qr/check│                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Userbot API]                                       │
│                         Создание MTProto сессии                             │
│                         Сохранение зашифрованной сессии                    │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [PostgreSQL]                                         │
│                         Создание/обновление подрядчика                      │
└────────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         [Telegram Bot]                                       │
│                         Главное меню разблокировано                         │
│                         ┌─────────────────────┐                             │
│                         │ 🆕 Новый канал      │                             │
│                         │ 📄 Рендер файлов    │                             │
│                         │ 📢 Мои каналы       │                             │
│                         └──────────┬──────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
        ┌───────────────────┐           ┌───────────────────┐
        │ Создать канал     │           │ Загрузить файл    │
        └─────────┬─────────┘           └─────────┬─────────┘
                  │                               │
                  │                               │
                  ▼                               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ВЕТКА 1: СОЗДАНИЕ КАНАЛА                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  [Telegram Bot]                                                      │   │
│  │  Сбор данных: название, аватарка                                     │   │
│  └────┬────────────────────────────────────────────────────────────────┘   │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  [Userbot API]                                                       │   │
│  │  POST /rooms/create                                                  │   │
│  │  ┌─────────────────────┐                                               │   │
│  │  │ Создание канала   │                                               │   │
│  │  │ ToggleNoForwards  │                                               │   │
│  │  └──────────┬──────────┘                                               │   │
│  └────┬───────┼────────────────────────────────────────────────────────┘   │
│       │       │                                                              │
│       │       ▼                                                              │
│       │  ┌─────────────────────────────────────────────────────────────┐   │
│       │  │  [Telegram API (MTProto)]                                    │   │
│       │  │  Создание приватного канала                                  │   │
│       │  └────┬──────────────────────────────────────────────────────────┘   │
│       │       │                                                              │
│       │       ▼                                                              │
│       │  ┌─────────────────────────────────────────────────────────────┐   │
│       │  │  [Userbot API]                                               │   │
│       │  │  POST /rooms/add_bot_admin                                   │   │
│       │  │  Назначение бота администратором                              │   │
│       │  └────┬──────────────────────────────────────────────────────────┘   │
│       │       │                                                              │
│       │       ▼                                                              │
│       │  ┌─────────────────────────────────────────────────────────────┐   │
│       │  │  [PostgreSQL]                                                │   │
│       │  │  Сохранение метаданных канала                                │   │
│       │  └────┬──────────────────────────────────────────────────────────┘   │
│       │       │                                                              │
│       │       ▼                                                              │
│       │  ┌─────────────────────────────────────────────────────────────┐   │
│       │  │  [Telegram Bot]                                              │   │
│       │  │  Создание одноразовой ссылки-приглашения                     │   │
│       │  │  Сохранение в PostgreSQL                                     │   │
│       │  │  ✅ Канал создан, ссылка готова                              │   │
│       │  └──────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ВЕТКА 2: ЗАГРУЗКА И ПУБЛИКАЦИЯ ФАЙЛА                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  [Telegram Bot]                                                      │   │
│  │  Пользователь загружает файл (PDF/DOC/XLS/PNG)                      │   │
│  │  ┌─────────────────────┐                                               │   │
│  │  │ Сохранение в Redis │                                               │   │
│  │  │ Key: pdf:uuid      │                                               │   │
│  │  └──────────┬──────────┘                                               │   │
│  └────┬────────┼──────────────────────────────────────────────────────────┘   │
│       │        │                                                              │
│       │        ▼                                                              │
│       │  ┌─────────────────────────────────────────────────────────────┐   │
│       │  │  [Redis]                                                     │   │
│       │  │  Временное хранение файла                                    │   │
│       │  └────┬──────────────────────────────────────────────────────────┘   │
│       │       │                                                              │
│       │       ▼                                                              │
│       │  ┌─────────────────────────────────────────────────────────────┐   │
│       │  │  [Telegram Bot]                                              │   │
│       │  │  Постановка задачи генерации превью                          │   │
│       │  │  Queue: preview                                              │   │
│       │  └────┬──────────────────────────────────────────────────────────┘   │
│       │       │                                                              │
│       │       ▼                                                              │
│       │  ┌─────────────────────────────────────────────────────────────┐   │
│       │  │  [Celery Queue: preview]                                     │   │
│       │  └────┬──────────────────────────────────────────────────────────┘   │
│       │       │                                                              │
│       │       ▼                                                              │
│       │  ┌─────────────────────────────────────────────────────────────┐   │
│       │  │  [Worker Preview]                                            │   │
│       │  │  ┌─────────────────────┐                                      │   │
│       │  │  │ Генерация превью   │                                      │   │
│       │  │  │ PDF → PNG → JPEG   │                                      │   │
│       │  │  └──────────┬──────────┘                                      │   │
│       │  └────┬────────┼──────────────────────────────────────────────────┘   │
│       │       │        │                                                      │
│       │       │        ▼                                                      │
│       │       │  ┌───────────────────────────────────────────────────────┐   │
│       │       │  │  [Redis]                                              │   │
│       │       │  │  Сохранение превью                                    │   │
│       │       │  └────┬───────────────────────────────────────────────────┘   │
│       │       │       │                                                      │
│       │       │       ▼                                                      │
│       │       │  ┌───────────────────────────────────────────────────────┐   │
│       │       │  │  [Telegram Bot]                                       │   │
│       │       │  │  Показ превью пользователю                            │   │
│       │       │  │  Выбор страниц и водяного знака                       │   │
│       │       │  └────┬───────────────────────────────────────────────────┘   │
│       │       │       │                                                      │
│       │       │       ▼                                                      │
│       │       │  ┌───────────────────────────────────────────────────────┐   │
│       │       │  │  [Telegram Bot]                                       │   │
│       │       │  │  Постановка задачи рендеринга                         │   │
│       │       │  │  Queue: pdf/office                                    │   │
│       │       │  └────┬───────────────────────────────────────────────────┘   │
│       │       │       │                                                      │
│       │       │       ▼                                                      │
│       │       │  ┌───────────────────────────────────────────────────────┐   │
│       │       │  │  [Celery Queue: pdf/office]                           │   │
│       │       │  └────┬───────────────────────────────────────────────────┘   │
│       │       │       │                                                      │
│       │       │       ▼                                                      │
│       │       │  ┌───────────────────────────────────────────────────────┐   │
│       │       │  │  [Worker PDF/Office]                                  │   │
│       │       │  │  ┌─────────────────────┐                              │   │
│       │       │  │  │ Конвертация в PNG   │                              │   │
│       │       │  │  │ 300 DPI             │                              │   │
│       │       │  │  │ Наложение водяного  │                              │   │
│       │       │  │  │ знака               │                              │   │
│       │       │  │  └──────────┬──────────┘                              │   │
│       │       │  └────┬────────┼───────────────────────────────────────────┘   │
│       │       │       │        │                                              │
│       │       │       │        ▼                                              │
│       │       │       │  ┌────────────────────────────────────────────────┐   │
│       │       │       │  │  [Redis]                                        │   │
│       │       │       │  │  Сохранение готовых PNG                         │   │
│       │       │       │  └────┬─────────────────────────────────────────────┘   │
│       │       │       │       │                                              │
│       │       │       │       ▼                                              │
│       │       │       │  ┌────────────────────────────────────────────────┐   │
│       │       │       │  │  [Worker PDF/Office]                           │   │
│       │       │       │  │  Постановка задачи публикации                   │   │
│       │       │       │  │  Queue: publish                                 │   │
│       │       │       │  └────┬─────────────────────────────────────────────┘   │
│       │       │       │       │                                              │
│       │       │       │       ▼                                              │
│       │       │       │  ┌────────────────────────────────────────────────┐   │
│       │       │       │  │  [Celery Queue: publish]                       │   │
│       │       │       │  └────┬─────────────────────────────────────────────┘   │
│       │       │       │       │                                              │
│       │       │       │       ▼                                              │
│       │       │       │  ┌────────────────────────────────────────────────┐   │
│       │       │       │  │  [Worker Publish]                               │   │
│       │       │       │  │  ┌─────────────────────┐                       │   │
│       │       │       │  │  │ Отправка в канал    │                       │   │
│       │       │       │  │  │ через Bot API       │                       │   │
│       │       │       │  │  │ protect_content=True│                      │   │
│       │       │       │  │  └──────────┬──────────┘                       │   │
│       │       │       │  └────┬────────┼───────────────────────────────────┘   │
│       │       │       │       │        │                                      │
│       │       │       │       │        ▼                                      │
│       │       │       │       │  ┌────────────────────────────────────────┐   │
│       │       │       │       │  │  [Telegram API]                          │   │
│       │       │       │       │  │  Публикация документа в канал            │   │
│       │       │       │       │  └────┬─────────────────────────────────────┘   │
│       │       │       │       │       │                                      │
│       │       │       │       │       ▼                                      │
│       │       │       │       │  ┌────────────────────────────────────────┐   │
│       │       │       │       │  │  [PostgreSQL]                           │   │
│       │       │       │       │  │  Сохранение метаданных публикации      │   │
│       │       │       │       │  └────┬─────────────────────────────────────┘   │
│       │       │       │       │       │                                      │
│       │       │       │       │       ▼                                      │
│       │       │       │       │  ┌────────────────────────────────────────┐   │
│       │       │       │       │  │  [Telegram Bot]                          │   │
│       │       │       │       │  │  ✅ Документ опубликован                 │   │
│       │       │       │       │  │  Уведомление пользователю                │   │
│       │       │       │       │  └──────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         РЕЗУЛЬТАТ: Пользователь получил результат            │
│                         - Канал создан и ссылка готова                       │
│                         - Документ опубликован в канале                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📦 Компоненты системы

### Основные компоненты

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         КОМПОНЕНТЫ СИСТЕМЫ                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Telegram Bot (aiogram)                                              │   │
│  │  • Обработка команд и сообщений                                      │   │
│  │  • Управление FSM состояниями                                        │   │
│  │  • Взаимодействие с пользователем                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Userbot API (FastAPI + Telethon)                                    │   │
│  │  • Управление MTProto сессиями                                       │   │
│  │  • Создание каналов через Telegram API                               │   │
│  │  • Авторизация через QR-код                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Celery Workers                                                      │   │
│  │  • Worker Preview: генерация превью                                   │   │
│  │  • Worker PDF/Office: конвертация документов                        │   │
│  │  • Worker Publish: публикация в каналы                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Хранилища                                                           │   │
│  │  • Redis: очереди задач, временные файлы, превью                    │   │
│  │  • PostgreSQL: метаданные, статистика                                │   │
│  │  • File System: зашифрованные сессии                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔀 Потоки данных

### Типы взаимодействий

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ТИПЫ ПОТОКОВ ДАННЫХ                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  1. HTTP запросы                                                             │
│     Telegram Bot ────→ Userbot API                                           │
│     WebApp ──────────→ Userbot API                                          │
│                                                                               │
│  2. Telegram API                                                             │
│     Userbot API ─────→ Telegram API (MTProto)                                │
│     Telegram Bot ────→ Telegram API (Bot API)                                │
│                                                                               │
│  3. Очереди задач (Celery)                                                   │
│     Telegram Bot ────→ Redis Queue ────→ Workers                             │
│                                                                               │
│  4. Хранилища                                                                │
│     Components ──────→ Redis (временные данные)                             │
│     Components ──────→ PostgreSQL (постоянные данные)                        │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 🎯 Ключевые логические точки

### 1. Проверка авторизации
- Бот проверяет наличие сессии через Userbot API
- Если сессии нет → запрос авторизации через WebApp
- Если сессия есть → разблокировка функционала

### 2. Создание канала
- Сбор данных от пользователя (название, аватарка)
- Создание канала через Userbot API (MTProto)
- Назначение бота администратором
- Сохранение метаданных в PostgreSQL
- Создание одноразовой ссылки-приглашения

### 3. Обработка файла
- Загрузка файла → сохранение в Redis
- Генерация превью → показ пользователю
- Выбор параметров (страницы, водяной знак)
- Конвертация в PNG 300 DPI с водяным знаком
- Публикация в канал с защитой контента
- Сохранение метаданных в PostgreSQL

---

## 📝 Легенда

```
┌──────────────┐  =  Компонент системы
│  [Component] │
└──────────────┘

    │           =  Поток данных (направление)
    ▼

    ────→       =  HTTP запрос / API вызов

    ────┐       =  Разветвление (условие)
    ────┘

    ────→       =  Задача в очереди (Celery)
```

---

**Версия документа:** 1.0  
**Дата создания:** 2024  
**Последнее обновление:** 2024

