# üìä SmetaBot ‚Äî –°—Ö–µ–º—ã –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏

## üìë –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#1-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
2. [–°—Ö–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ QR-–∫–æ–¥](#2-—Å—Ö–µ–º–∞-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏-—á–µ—Ä–µ–∑-qr-–∫–æ–¥)
3. [–°—Ü–µ–Ω–∞—Ä–∏–π: –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –ø–æ–¥—Ä—è–¥—á–∏–∫–∞](#3-—Å—Ü–µ–Ω–∞—Ä–∏–π-–ø–µ—Ä–≤—ã–π-–∑–∞–ø—É—Å–∫-–ø–æ–¥—Ä—è–¥—á–∏–∫–∞)
4. [–°—Ü–µ–Ω–∞—Ä–∏–π: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞](#4-—Å—Ü–µ–Ω–∞—Ä–∏–π-—Å–æ–∑–¥–∞–Ω–∏–µ-–∫–∞–Ω–∞–ª–∞)
5. [–°—Ü–µ–Ω–∞—Ä–∏–π: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞](#5-—Å—Ü–µ–Ω–∞—Ä–∏–π-–ø—É–±–ª–∏–∫–∞—Ü–∏—è-–¥–æ–∫—É–º–µ–Ω—Ç–∞)
6. [–°—Ü–µ–Ω–∞—Ä–∏–π: –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø](#6-—Å—Ü–µ–Ω–∞—Ä–∏–π-–∫–ª–∏–µ–Ω—Ç-–ø–æ–ª—É—á–∞–µ—Ç-–¥–æ—Å—Ç—É–ø)
7. [–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö: –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞](#7-–ø–æ—Ç–æ–∫-–¥–∞–Ω–Ω—ã—Ö-–æ–±—Ä–∞–±–æ—Ç–∫–∞-–¥–æ–∫—É–º–µ–Ω—Ç–∞)
8. [–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#8-—Å—Ö–µ–º–∞-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
9. [–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è](#9-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è)
10. [–°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤](#10-—Å—Ö–µ–º–∞-–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)

---

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### 1.1. –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
graph TB
    subgraph "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"
        Contractor[–ü–æ–¥—Ä—è–¥—á–∏–∫<br/>Telegram]
        Client[–ö–ª–∏–µ–Ω—Ç<br/>Telegram]
    end

    subgraph "Frontend Layer"
        Bot[Telegram Bot<br/>aiogram]
        WebApp[WebApp<br/>HTML/JS]
    end

    subgraph "API Layer"
        UserbotAPI[Userbot API<br/>FastAPI + Telethon]
        BackendAPI[Backend API<br/>FastAPI]
    end

    subgraph "Processing Layer"
        WorkerPDF[Celery Worker<br/>PDF Queue]
        WorkerOffice[Celery Worker<br/>Office Queue]
        WorkerPublish[Celery Worker<br/>Publish Queue]
        WorkerPreview[Celery Worker<br/>Preview Queue]
    end

    subgraph "Storage Layer"
        Redis[(Redis<br/>Queue + Cache)]
        PostgreSQL[(PostgreSQL<br/>Database)]
        Sessions[File System<br/>Encrypted Sessions]
    end

    subgraph "External Services"
        TelegramAPI[Telegram API<br/>Bot + MTProto]
        LibreOffice[LibreOffice<br/>Document Converter]
    end

    Contractor -->|–ö–æ–º–∞–Ω–¥—ã| Bot
    Client -->|Join Request| Bot
    Contractor -->|WebApp| WebApp
    WebApp -->|HTTP| UserbotAPI
    Bot -->|HTTP| UserbotAPI
    Bot -->|HTTP| BackendAPI
    Bot -->|Tasks| Redis
    Bot -->|Queries| PostgreSQL

    UserbotAPI -->|MTProto| TelegramAPI
    UserbotAPI -->|Read/Write| Sessions
    UserbotAPI -->|Queries| PostgreSQL

    WorkerPDF -->|Read| Redis
    WorkerPDF -->|Write| PostgreSQL
    WorkerPDF -->|Publish| TelegramAPI
    WorkerOffice -->|Read| Redis
    WorkerOffice -->|Write| PostgreSQL
    WorkerOffice -->|Convert| LibreOffice
    WorkerOffice -->|Publish| TelegramAPI
    WorkerPublish -->|Read| Redis
    WorkerPublish -->|Write| PostgreSQL
    WorkerPublish -->|Publish| TelegramAPI
    WorkerPreview -->|Read| Redis
    WorkerPreview -->|Write| Redis

    Redis -->|Tasks| WorkerPDF
    Redis -->|Tasks| WorkerOffice
    Redis -->|Tasks| WorkerPublish
    Redis -->|Tasks| WorkerPreview

    style Bot fill:#2ea6ff,color:#fff
    style UserbotAPI fill:#00d4aa,color:#fff
    style BackendAPI fill:#00d4aa,color:#fff
    style Redis fill:#dc382d,color:#fff
    style PostgreSQL fill:#336791,color:#fff
```

### 1.2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ

```mermaid
graph LR
    subgraph "Bot Service"
        BotMain[main.py]
        Handlers[handlers/]
        Services[services/]
        Storage[storage.py]
    end

    subgraph "Userbot Service"
        UserbotAPI[api.py]
        Login[login.py]
        TGOps[tg_ops/]
    end

    subgraph "Worker Service"
        CeleryApp[celery_app.py]
        RenderTasks[tasks/render/]
        PublishTasks[tasks/publish.py]
        PreviewTasks[tasks/preview.py]
        StatsTasks[tasks/stats.py]
    end

    subgraph "Common Libraries"
        PreviewLib[common/preview.py]
        WatermarkLib[common/watermark.py]
    end

    BotMain --> Handlers
    Handlers --> Services
    Services --> Storage
    Handlers -->|HTTP| UserbotAPI
    Handlers -->|Tasks| CeleryApp

    UserbotAPI --> Login
    UserbotAPI --> TGOps

    CeleryApp --> RenderTasks
    CeleryApp --> PublishTasks
    CeleryApp --> PreviewTasks
    CeleryApp --> StatsTasks

    RenderTasks --> PreviewLib
    RenderTasks --> WatermarkLib
    PreviewTasks --> PreviewLib
```

---

## 2. –°—Ö–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ QR-–∫–æ–¥

### 2.1. –ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```mermaid
sequenceDiagram
    participant U as –ü–æ–¥—Ä—è–¥—á–∏–∫
    participant B as Telegram Bot
    participant W as WebApp
    participant UA as Userbot API
    participant T as Telegram API
    participant S as Sessions Storage

    U->>B: /start –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç"
    B->>UA: GET /session/status?contractor_id=X
    UA-->>B: {has_session: false}
    B->>U: –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å WebApp"
    
    U->>W: –û—Ç–∫—Ä—ã—Ç—å WebApp
    W->>UA: GET /session/status?contractor_id=X&verify=true
    UA-->>W: {has_session: false}
    
    W->>UA: POST /login/qr/start {contractor_id: X}
    UA->>T: client.qr_login()
    T-->>UA: QR-–∫–æ–¥ (base64)
    UA-->>W: {token: "xxx", qr_code: "base64_image"}
    
    W->>W: –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å QR-–∫–æ–¥
    Note over U,T: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥<br/>–≤ Telegram Desktop/Web
    
    W->>UA: POST /login/qr/check {token: "xxx"}
    UA->>T: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ QR-–ª–æ–≥–∏–Ω–∞
    alt QR-–∫–æ–¥ –Ω–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω
        T-->>UA: waiting
        UA-->>W: {status: "waiting"}
        W->>W: –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫
    else QR-–∫–æ–¥ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω, –æ–∂–∏–¥–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        T-->>UA: waiting_for_password (2FA)
        UA-->>W: {status: "2fa_required"}
        W->>U: –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å 2FA
        U->>W: –í–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å
        W->>UA: POST /login/qr/2fa {token: "xxx", password: "***"}
        UA->>T: client.sign_in(password)
    else QR-–∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω
        T-->>UA: authorized
        UA->>UA: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é (StringSession)
        UA->>S: –ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é
        UA-->>W: {status: "ready", me: {...}}
        W->>B: tg.sendData({action: "session_ready"})
        B->>UA: GET /session/status?contractor_id=X&verify=true
        UA-->>B: {has_session: true, authorized: true}
        B->>U: ‚úÖ –ê–∫–∫–∞—É–Ω—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω. –ú–µ–Ω—é —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ.
    end
```

### 2.2. –°—Ö–µ–º–∞ WebApp –¥–ª—è QR-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```mermaid
stateDiagram-v2
    [*] --> –ü—Ä–æ–≤–µ—Ä–∫–∞–°–µ—Å—Å–∏–∏
    
    –ü—Ä–æ–≤–µ—Ä–∫–∞–°–µ—Å—Å–∏–∏ --> –ü–æ–∫–∞–∑QR: –°–µ—Å—Å–∏–∏ –Ω–µ—Ç
    –ü—Ä–æ–≤–µ—Ä–∫–∞–°–µ—Å—Å–∏–∏ --> –£—Å–ø–µ—Ö: –°–µ—Å—Å–∏—è –µ—Å—Ç—å
    
    –ü–æ–∫–∞–∑QR --> –û–∂–∏–¥–∞–Ω–∏–µ–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: QR-–∫–æ–¥ –ø–æ–ª—É—á–µ–Ω
    –û–∂–∏–¥–∞–Ω–∏–µ–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è --> –ü—Ä–æ–≤–µ—Ä–∫–∞–°—Ç–∞—Ç—É—Å–∞: –ö–∞–∂–¥—ã–µ 2 —Å–µ–∫
    
    –ü—Ä–æ–≤–µ—Ä–∫–∞–°—Ç–∞—Ç—É—Å–∞ --> –û–∂–∏–¥–∞–Ω–∏–µ–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: waiting
    –ü—Ä–æ–≤–µ—Ä–∫–∞–°—Ç–∞—Ç—É—Å–∞ --> –ó–∞–ø—Ä–æ—Å–ü–∞—Ä–æ–ª—è: waiting_for_password
    –ü—Ä–æ–≤–µ—Ä–∫–∞–°—Ç–∞—Ç—É—Å–∞ --> –£—Å–ø–µ—Ö: authorized
    
    –ó–∞–ø—Ä–æ—Å–ü–∞—Ä–æ–ª—è --> –í–≤–æ–¥–ü–∞—Ä–æ–ª—è: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø–∞—Ä–æ–ª—å
    –í–≤–æ–¥–ü–∞—Ä–æ–ª—è --> –ü—Ä–æ–≤–µ—Ä–∫–∞–°—Ç–∞—Ç—É—Å–∞: –ü–∞—Ä–æ–ª—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
    
    –£—Å–ø–µ—Ö --> [*]: –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
    
    note right of –ü–æ–∫–∞–∑QR
        –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ QR-–∫–æ–¥–∞
        –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: "–û—Ç–∫—Ä–æ–π—Ç–µ Telegram Desktop/Web
        –∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥"
    end note
    
    note right of –ó–∞–ø—Ä–æ—Å–ü–∞—Ä–æ–ª—è
        –ï—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω 2FA,
        –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å
    end note
```

### 2.3. API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è QR-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```mermaid
graph TB
    subgraph "QR Login Endpoints"
        Start[POST /login/qr/start<br/>–ù–∞—á–∞—Ç—å QR-–ª–æ–≥–∏–Ω]
        Check[POST /login/qr/check<br/>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å]
        TwoFA[POST /login/qr/2fa<br/>–í–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å 2FA]
    end

    subgraph "Telethon Methods"
        QRLogin[client.qr_login<br/>–ü–æ–ª—É—á–∏—Ç—å QR-–∫–æ–¥]
        QRCheck[client.qr_login<br/>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å]
        SignIn[client.sign_in<br/>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å –ø–∞—Ä–æ–ª–µ–º]
    end

    subgraph "Storage"
        Pending[_pending_qr<br/>–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ]
        Session[Encrypted Session<br/>–§–∞–π–ª .session.enc]
    end

    Start --> QRLogin
    QRLogin --> Pending
    QRLogin --> Start
    
    Check --> QRCheck
    QRCheck --> Pending
    QRCheck --> Check
    
    TwoFA --> SignIn
    SignIn --> Session
    SignIn --> TwoFA
    
    style Start fill:#2ea6ff,color:#fff
    style Check fill:#2ea6ff,color:#fff
    style TwoFA fill:#2ea6ff,color:#fff
```

---

## 3. –°—Ü–µ–Ω–∞—Ä–∏–π: –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –ø–æ–¥—Ä—è–¥—á–∏–∫–∞

### 3.1. –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```mermaid
sequenceDiagram
    participant U as –ü–æ–¥—Ä—è–¥—á–∏–∫
    participant B as Telegram Bot
    participant W as WebApp
    participant UA as Userbot API
    participant DB as PostgreSQL
    participant T as Telegram API

    U->>B: /start
    B->>UA: GET /session/status?contractor_id=123
    UA-->>B: {has_session: false}
    
    B->>U: –ü—Ä–∏–≤–µ—Ç! –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç —á–µ—Ä–µ–∑ WebApp
    B->>U: [–ö–Ω–æ–ø–∫–∞: "üîê –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç (WebApp)"]
    
    U->>W: –û—Ç–∫—Ä—ã—Ç—å WebApp
    W->>UA: GET /session/status?contractor_id=123&verify=true
    UA-->>W: {has_session: false}
    
    W->>UA: POST /login/qr/start {contractor_id: "123"}
    UA->>T: client.qr_login()
    T-->>UA: QR-–∫–æ–¥ (base64)
    UA-->>W: {token: "abc123", qr_code: "data:image/png;base64,..."}
    
    W->>U: –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å QR-–∫–æ–¥ + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
    
    loop –ö–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        W->>UA: POST /login/qr/check {token: "abc123"}
        UA->>T: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
        T-->>UA: waiting
        UA-->>W: {status: "waiting"}
    end
    
    Note over U,T: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥<br/>–≤ Telegram Desktop/Web
    
    W->>UA: POST /login/qr/check {token: "abc123"}
    UA->>T: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    T-->>UA: authorized
    UA->>UA: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å StringSession
    UA->>UA: –ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å Fernet
    UA->>UA: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª 123.session.enc
    UA-->>W: {status: "ready", me: {id: 123, username: "user"}}
    
    W->>B: tg.sendData({action: "session_ready"})
    B->>UA: GET /session/status?contractor_id=123&verify=true
    UA->>UA: –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Å—Å–∏—é
    UA-->>B: {has_session: true, authorized: true}
    
    B->>DB: INSERT INTO core.contractors (tg_user_id, ...)
    DB-->>B: contractor_id
    
    B->>U: ‚úÖ –ê–∫–∫–∞—É–Ω—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω! –ú–µ–Ω—é —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ.
    B->>U: [–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏]
```

### 3.2. –ë–ª–æ–∫-—Å—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

```mermaid
flowchart TD
    Start([–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç /start]) --> CheckSession{–°–µ—Å—Å–∏—è<br/>–µ—Å—Ç—å?}
    
    CheckSession -->|–ù–µ—Ç| ShowWebApp[–ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É<br/>"–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç"]
    CheckSession -->|–î–∞| ShowMenu[–ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é]
    
    ShowWebApp --> OpenWebApp[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç WebApp]
    OpenWebApp --> RequestQR[POST /login/qr/start]
    
    RequestQR --> GetQR[–ü–æ–ª—É—á–∏—Ç—å QR-–∫–æ–¥ –æ—Ç Telegram]
    GetQR --> DisplayQR[–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å QR-–∫–æ–¥ –≤ WebApp]
    
    DisplayQR --> WaitScan[–û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è]
    WaitScan --> CheckStatus{–ü—Ä–æ–≤–µ—Ä–∏—Ç—å<br/>—Å—Ç–∞—Ç—É—Å}
    
    CheckStatus -->|waiting| WaitScan
    CheckStatus -->|2fa_required| RequestPassword[–ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å 2FA]
    CheckStatus -->|authorized| SaveSession[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é]
    
    RequestPassword --> InputPassword[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø–∞—Ä–æ–ª—å]
    InputPassword --> SendPassword[POST /login/qr/2fa]
    SendPassword --> SaveSession
    
    SaveSession --> EncryptSession[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏—é Fernet]
    EncryptSession --> SaveFile[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª<br/>contractor_id.session.enc]
    
    SaveFile --> NotifyBot[–û—Ç–ø—Ä–∞–≤–∏—Ç—å session_ready –≤ –±–æ—Ç–∞]
    NotifyBot --> VerifySession[–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Å—Å–∏—é —á–µ—Ä–µ–∑ API]
    VerifySession --> CreateContractor[–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ –ë–î]
    CreateContractor --> ShowMenu
    
    ShowMenu --> End([–ì–æ—Ç–æ–≤–æ])
    
    style Start fill:#90EE90
    style End fill:#FFB6C1
    style SaveSession fill:#87CEEB
    style ShowMenu fill:#DDA0DD
```

---

## 4. –°—Ü–µ–Ω–∞—Ä–∏–π: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞

### 4.1. –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```mermaid
sequenceDiagram
    participant U as –ü–æ–¥—Ä—è–¥—á–∏–∫
    participant B as Telegram Bot
    participant UA as Userbot API
    participant T as Telegram API
    participant DB as PostgreSQL
    participant Billing as Billing Service

    U->>B: –ù–∞–∂–∞—Ç—å "üÜï –ù–æ–≤—ã–π –∫–∞–Ω–∞–ª"
    B->>UA: GET /session/status?contractor_id=123
    UA-->>B: {has_session: true, authorized: true}
    
    B->>U: –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
    U->>B: "–ü—Ä–æ–µ–∫—Ç –ò–≤–∞–Ω–æ–≤–∞"
    
    B->>U: –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä–∫—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    alt –ê–≤–∞—Ç–∞—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
        U->>B: [–§–æ—Ç–æ]
        B->>B: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ
    end
    
    B->>DB: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏
    DB->>Billing: can_create_channel(contractor_id)
    Billing-->>DB: {can_create: true, reason: null}
    DB-->>B: OK
    
    B->>UA: POST /rooms/create {contractor_id: "123", title: "–ü—Ä–æ–µ–∫—Ç –ò–≤–∞–Ω–æ–≤–∞"}
    UA->>UA: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏—é –ø–æ–¥—Ä—è–¥—á–∏–∫–∞
    UA->>T: CreateChannelRequest(title, megagroup=False)
    T-->>UA: Channel created (channel_id: -1001234567890)
    
    UA->>T: ToggleNoForwardsRequest(enabled=True)
    T-->>UA: OK (–∑–∞–ø—Ä–µ—Ç —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥–∞ –≤–∫–ª—é—á—ë–Ω)
    
    UA-->>B: {channel_id: -1001234567890}
    
    B->>UA: POST /rooms/add_bot_admin {channel_id: -1001234567890, bot_username: "@smetabot"}
    UA->>T: EditAdminRequest(bot, rights: post_messages, invite_users)
    T-->>UA: OK (–±–æ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º)
    UA-->>B: {ok: true}
    
    alt –ê–≤–∞—Ç–∞—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
        B->>T: set_chat_photo(chat_id, photo)
        T-->>B: OK
    end
    
    B->>DB: INSERT INTO core.channels (contractor_id, tg_chat_id, title, ...)
    DB-->>B: channel_db_id
    
    B->>DB: UPDATE billing.usage_counters SET channels_created_total = channels_created_total + 1
    
    B->>T: create_chat_invite_link(chat_id, creates_join_request=True, member_limit=1)
    T-->>B: invite_link: "https://t.me/join/..."
    
    B->>DB: INSERT INTO core.invites (channel_id, token, max_uses=1, ...)
    
    B->>U: ‚úÖ –ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω!<br/>–ù–∞–∑–≤–∞–Ω–∏–µ: –ü—Ä–æ–µ–∫—Ç –ò–≤–∞–Ω–æ–≤–∞<br/>–°—Å—ã–ª–∫–∞: https://t.me/join/...
```

### 4.2. –ë–ª–æ–∫-—Å—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

```mermaid
flowchart TD
    Start([–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ù–æ–≤—ã–π –∫–∞–Ω–∞–ª"]) --> CheckSession{–°–µ—Å—Å–∏—è<br/>–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞?}
    
    CheckSession -->|–ù–µ—Ç| RequestAuth[–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é]
    CheckSession -->|–î–∞| InputTitle[–í–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞]
    
    InputTitle --> OptionalAvatar{–ó–∞–≥—Ä—É–∑–∏—Ç—å<br/>–∞–≤–∞—Ç–∞—Ä–∫—É?}
    OptionalAvatar -->|–î–∞| UploadAvatar[–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ]
    OptionalAvatar -->|–ù–µ—Ç| CheckLimits
    UploadAvatar --> CheckLimits
    
    CheckLimits{–ü—Ä–æ–≤–µ—Ä–∏—Ç—å<br/>–ª–∏–º–∏—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏} -->|–ü—Ä–µ–≤—ã—à–µ–Ω| ShowError[–û—à–∏–±–∫–∞: –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω]
    CheckLimits -->|OK| CreateChannel[POST /rooms/create]
    
    CreateChannel --> EnableNoForwards[–í–∫–ª—é—á–∏—Ç—å ToggleNoForwardsRequest]
    EnableNoForwards --> AddBotAdmin[POST /rooms/add_bot_admin]
    
    AddBotAdmin --> SetAvatar{–ê–≤–∞—Ç–∞—Ä–∫–∞<br/>–µ—Å—Ç—å?}
    SetAvatar -->|–î–∞| SetPhoto[–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ç–æ –∫–∞–Ω–∞–ª–∞]
    SetAvatar -->|–ù–µ—Ç| SaveToDB
    SetPhoto --> SaveToDB
    
    SaveToDB[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ core.channels] --> IncrementCounter[–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á—ë—Ç—á–∏–∫–∞ –∫–∞–Ω–∞–ª–æ–≤]
    IncrementCounter --> CreateInvite[–°–æ–∑–¥–∞—Ç—å –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—É—é —Å—Å—ã–ª–∫—É]
    CreateInvite --> SaveInvite[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ core.invites]
    SaveInvite --> ShowSuccess[–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]
    
    ShowError --> End([–ö–æ–Ω–µ—Ü])
    ShowSuccess --> End
    
    style Start fill:#90EE90
    style End fill:#FFB6C1
    style CreateChannel fill:#87CEEB
    style ShowSuccess fill:#DDA0DD
```

---

## 5. –°—Ü–µ–Ω–∞—Ä–∏–π: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞

### 5.1. –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏

```mermaid
sequenceDiagram
    participant U as –ü–æ–¥—Ä—è–¥—á–∏–∫
    participant B as Telegram Bot
    participant R as Redis
    participant WP as Worker Preview
    participant WR as Worker Render
    participant WPUB as Worker Publish
    participant T as Telegram API
    participant DB as PostgreSQL
    participant LO as LibreOffice
    participant WM as Watermark

    U->>B: –í—ã–±—Ä–∞—Ç—å "üìÑ PDF ‚Üí PNG"
    B->>U: –ü—Ä–∏—à–ª–∏—Ç–µ PDF-—Ñ–∞–π–ª
    
    U->>B: [PDF —Ñ–∞–π–ª: smeta.pdf]
    B->>R: SET pdf:uuid-123 [file_bytes] EX 86400
    R-->>B: OK
    
    B->>WP: generate_preview_task(pdf_key="pdf:uuid-123")
    WP->>R: GET pdf:uuid-123
    R-->>WP: [file_bytes]
    
    WP->>WP: PyMuPDF: PDF ‚Üí PNG (300 DPI)
    WP->>WP: –°–æ–∑–¥–∞—Ç—å thumbnail (JPEG 1600px)
    WP->>R: SET preview:uuid-123 [thumbnail] EX 3600
    WP-->>B: –ü—Ä–µ–≤—å—é –≥–æ—Ç–æ–≤–æ
    
    B->>U: –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é —Å—Ç—Ä–∞–Ω–∏—Ü
    U->>B: –í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã: [1, 3, 5]
    U->>B: –í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫: "–ò–≤–∞–Ω–æ–≤ –ò.–ò."
    
    B->>WR: process_and_publish_pdf(chat_id, pdf_key, page_indices=[1,3,5], watermark_text)
    WR->>R: GET pdf:uuid-123
    R-->>WR: [file_bytes]
    R->>R: DEL pdf:uuid-123
    
    WR->>WR: PyMuPDF: PDF ‚Üí PNG (300 DPI) –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü [1,3,5]
    
    loop –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        WR->>WM: apply_tiled_watermark(png, "–ò–≤–∞–Ω–æ–≤ –ò.–ò.")
        WM-->>WR: PNG —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º
        WR->>WPUB: send_document(chat_id, png_bytes, filename, protect_content=True)
        WPUB->>T: sendDocument(chat_id, document, protect_content=True)
        T-->>WPUB: {ok: true, message_id: 123}
        WPUB->>DB: INSERT INTO core.publications (channel_id, message_id, file_name, views)
    end
    
    WR-->>B: –£—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ 3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    B->>U: ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –≤ –∫–∞–Ω–∞–ª–µ
```

### 5.2. –°—Ö–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤

```mermaid
flowchart TD
    Start([–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª]) --> DetectType{–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å<br/>—Ç–∏–ø —Ñ–∞–π–ª–∞}
    
    DetectType -->|PDF| StorePDF[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Redis:<br/>pdf:uuid]
    DetectType -->|DOC/DOCX| StoreDOC[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Redis:<br/>doc:uuid]
    DetectType -->|XLS/XLSX| StoreXLS[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Redis:<br/>xls:uuid]
    DetectType -->|PNG| StorePNG[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Redis:<br/>png:uuid]
    
    StorePDF --> GeneratePreview[–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é]
    StoreDOC --> GeneratePreview
    StoreXLS --> GeneratePreview
    StorePNG --> SkipPreview[–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–µ–≤—å—é]
    
    GeneratePreview --> ShowPreview[–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]
    ShowPreview --> SelectPages[–í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã/–ª–∏—Å—Ç—ã]
    SelectPages --> InputWatermark[–í–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞]
    
    SkipPreview --> InputWatermark
    
    InputWatermark --> QueueTask{–ü–æ—Å—Ç–∞–≤–∏—Ç—å –≤<br/>–æ—á–µ—Ä–µ–¥—å}
    
    QueueTask -->|PDF| QueuePDF[–û—á–µ—Ä–µ–¥—å: pdf]
    QueueTask -->|DOC/XLS| QueueOffice[–û—á–µ—Ä–µ–¥—å: office]
    QueueTask -->|PNG| QueuePublish[–û—á–µ—Ä–µ–¥—å: publish]
    
    QueuePDF --> RenderPDF[Worker: PDF ‚Üí PNG 300 DPI]
    QueueOffice --> ConvertOffice[Worker: LibreOffice ‚Üí PDF]
    ConvertOffice --> RenderPDF
    QueuePublish --> NormalizePNG[Worker: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è PNG 300 DPI]
    
    RenderPDF --> ApplyWatermark[–ù–∞–ª–æ–∂–∏—Ç—å –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫]
    NormalizePNG --> ApplyWatermark
    
    ApplyWatermark --> Publish[–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∫–∞–Ω–∞–ª<br/>protect_content=True]
    Publish --> SaveDB[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ core.publications]
    SaveDB --> DeleteTemp[–£–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∏–∑ Redis]
    DeleteTemp --> End([–ì–æ—Ç–æ–≤–æ])
    
    style Start fill:#90EE90
    style End fill:#FFB6C1
    style ApplyWatermark fill:#87CEEB
    style Publish fill:#DDA0DD
```

### 5.3. –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

```mermaid
graph TB
    subgraph "PDF Processing"
        PDF1[PDF File] --> PDF2[PyMuPDF<br/>fitz.open]
        PDF2 --> PDF3[page.get_pixmap<br/>dpi=300]
        PDF3 --> PDF4[PNG 300 DPI]
    end
    
    subgraph "DOC/DOCX Processing"
        DOC1[DOC/DOCX File] --> DOC2[LibreOffice<br/>--convert-to pdf]
        DOC2 --> DOC3[PDF File]
        DOC3 --> PDF2
    end
    
    subgraph "XLS/XLSX Processing"
        XLS1[XLS/XLSX File] --> XLS2[LibreOffice<br/>--convert-to pdf]
        XLS2 --> XLS3[PDF File]
        XLS3 --> PDF2
        XLS1 --> XLS4[openpyxl<br/>–ü–æ–∏—Å–∫ —Ç–∞–±–ª–∏—Ü]
        XLS4 --> XLS2
    end
    
    subgraph "Watermark Application"
        PDF4 --> WM1[PIL Image.open]
        WM1 --> WM2[apply_tiled_watermark<br/>text, opacity, angle]
        WM2 --> WM3[PNG with Watermark]
    end
    
    subgraph "Publishing"
        WM3 --> PUB1[Telegram Bot API<br/>sendDocument]
        PUB1 --> PUB2[protect_content=True]
        PUB2 --> PUB3[Message in Channel]
    end
    
    style PDF2 fill:#87CEEB
    style WM2 fill:#DDA0DD
    style PUB2 fill:#90EE90
```

---

## 6. –°—Ü–µ–Ω–∞—Ä–∏–π: –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø

### 6.1. –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```mermaid
sequenceDiagram
    participant C as –ö–ª–∏–µ–Ω—Ç
    participant B as Telegram Bot
    participant T as Telegram API
    participant DB as PostgreSQL

    Note over C,DB: –ü–æ–¥—Ä—è–¥—á–∏–∫ —Å–æ–∑–¥–∞–ª —Å—Å—ã–ª–∫—É-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
    
    C->>T: –ü–µ—Ä–µ–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ<br/>https://t.me/join/...
    T->>B: ChatJoinRequest<br/>(user_id, chat_id)
    
    B->>DB: SELECT * FROM core.channels<br/>WHERE tg_chat_id = chat_id
    DB-->>B: channel record
    
    B->>DB: SELECT * FROM core.invites<br/>WHERE channel_id = channel_id<br/>AND token = invite_link
    DB-->>B: invite record
    
    B->>B: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç—ã:<br/>used_count < max_uses?<br/>expires_at > now()?
    
    alt –õ–∏–º–∏—Ç—ã –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω—ã
        B->>T: approve_chat_join_request<br/>(chat_id, user_id)
        T-->>B: OK
        
        B->>DB: UPDATE core.invites<br/>SET used_count = used_count + 1
        
        B->>DB: INSERT INTO core.clients<br/>(channel_id, invite_id, tg_user_id, ...)
        
        B->>DB: INSERT INTO analytics.events<br/>(event_type: 'client_join', ...)
        
        C->>T: –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É
        T-->>C: –ö–∞–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç
    else –õ–∏–º–∏—Ç—ã –ø—Ä–µ–≤—ã—à–µ–Ω—ã
        B->>T: decline_chat_join_request<br/>(chat_id, user_id)
        T-->>B: OK
        B->>C: –ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—ë–Ω<br/>(–ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –∏—Å—á–µ—Ä–ø–∞–Ω)
    end
```

### 6.2. –ë–ª–æ–∫-—Å—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

```mermaid
flowchart TD
    Start([–ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ]) --> JoinRequest[Telegram: ChatJoinRequest]
    
    JoinRequest --> CheckChannel{–ö–∞–Ω–∞–ª<br/>–Ω–∞–π–¥–µ–Ω –≤ –ë–î?}
    CheckChannel -->|–ù–µ—Ç| Decline1[–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å]
    CheckChannel -->|–î–∞| CheckInvite{–ò–Ω–≤–∞–π—Ç<br/>–Ω–∞–π–¥–µ–Ω?}
    
    CheckInvite -->|–ù–µ—Ç| Decline1
    CheckInvite -->|–î–∞| CheckLimits{–ü—Ä–æ–≤–µ—Ä–∏—Ç—å<br/>–ª–∏–º–∏—Ç—ã}
    
    CheckLimits -->|used_count >= max_uses| Decline2[–û—Ç–∫–ª–æ–Ω–∏—Ç—å:<br/>–ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π]
    CheckLimits -->|expires_at < now| Decline3[–û—Ç–∫–ª–æ–Ω–∏—Ç—å:<br/>—Å—Ä–æ–∫ –∏—Å—Ç—ë–∫]
    CheckLimits -->|–õ–∏–º–∏—Ç—ã OK| Approve[–û–¥–æ–±—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å]
    
    Approve --> IncrementUsed[–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç used_count]
    IncrementUsed --> SaveClient[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ core.clients]
    SaveClient --> LogEvent[–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ<br/>client_join]
    LogEvent --> GrantAccess[–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É]
    
    Decline1 --> End([–ö–æ–Ω–µ—Ü])
    Decline2 --> End
    Decline3 --> End
    GrantAccess --> End
    
    style Start fill:#90EE90
    style End fill:#FFB6C1
    style Approve fill:#87CEEB
    style GrantAccess fill:#DDA0DD
```

---

## 7. –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö: –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞

### 7.1. –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```mermaid
flowchart LR
    subgraph "Input"
        File[PDF/DOC/XLS File]
    end
    
    subgraph "Storage Layer"
        Redis1[(Redis<br/>pdf:uuid<br/>TTL: 24h)]
        Redis2[(Redis<br/>preview:uuid<br/>TTL: 1h)]
        Redis3[(Redis<br/>renderpng:uuid<br/>TTL: 12h)]
    end
    
    subgraph "Processing"
        Preview[Preview Worker<br/>Generate Thumbnail]
        Render[Render Worker<br/>Convert to PNG 300 DPI]
        Watermark[Apply Watermark]
    end
    
    subgraph "Output"
        Channel[Telegram Channel<br/>protect_content=True]
        DB[(PostgreSQL<br/>core.publications)]
    end
    
    File -->|Store| Redis1
    Redis1 -->|Read| Preview
    Preview -->|Write| Redis2
    Redis2 -->|User selects pages| Render
    Redis1 -->|Read & Delete| Render
    Render -->|Write| Redis3
    Redis3 -->|Read| Watermark
    Watermark -->|Publish| Channel
    Channel -->|Metadata| DB
    DB -->|Cleanup| Redis3
    
    style File fill:#90EE90
    style Channel fill:#FFB6C1
    style Watermark fill:#87CEEB
```

### 7.2. –°—Ö–µ–º–∞ –æ—á–µ—Ä–µ–¥–µ–π Celery

```mermaid
graph TB
    subgraph "Bot"
        BotTask[–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏]
    end
    
    subgraph "Redis Queue"
        QueuePDF[–û—á–µ—Ä–µ–¥—å: pdf]
        QueueOffice[–û—á–µ—Ä–µ–¥—å: office]
        QueuePublish[–û—á–µ—Ä–µ–¥—å: publish]
        QueuePreview[–û—á–µ—Ä–µ–¥—å: preview]
    end
    
    subgraph "Workers"
        WorkerPDF[Worker PDF<br/>Concurrency: 3]
        WorkerOffice[Worker Office<br/>Concurrency: 1]
        WorkerPublish[Worker Publish<br/>Concurrency: 2]
        WorkerPreview[Worker Preview<br/>Concurrency: 2]
    end
    
    subgraph "Tasks"
        TaskPDF[process_and_publish_pdf]
        TaskDOC[process_and_publish_doc]
        TaskXLS[process_and_publish_excel]
        TaskPNG[process_and_publish_png]
        TaskPreview[generate_preview_task]
    end
    
    BotTask -->|PDF| QueuePDF
    BotTask -->|DOC/DOCX| QueueOffice
    BotTask -->|XLS/XLSX| QueueOffice
    BotTask -->|PNG| QueuePublish
    BotTask -->|Preview| QueuePreview
    
    QueuePDF --> WorkerPDF
    QueueOffice --> WorkerOffice
    QueuePublish --> WorkerPublish
    QueuePreview --> WorkerPreview
    
    WorkerPDF --> TaskPDF
    WorkerOffice --> TaskDOC
    WorkerOffice --> TaskXLS
    WorkerPublish --> TaskPNG
    WorkerPreview --> TaskPreview
    
    style BotTask fill:#90EE90
    style QueuePDF fill:#FFB6C1
    style QueueOffice fill:#FFB6C1
    style QueuePublish fill:#FFB6C1
    style QueuePreview fill:#FFB6C1
```

---

## 8. –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### 8.1. ER-–¥–∏–∞–≥—Ä–∞–º–º–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π

```mermaid
erDiagram
    CONTRACTORS ||--o{ CHANNELS : owns
    CONTRACTORS ||--o{ SUBSCRIPTIONS : has
    CONTRACTORS ||--o{ USAGE_COUNTERS : tracks
    CONTRACTORS ||--o{ GIFTS_QUEUE : queued
    
    CHANNELS ||--o{ PUBLICATIONS : publishes
    CHANNELS ||--o{ INVITES : creates
    CHANNELS ||--o{ CLIENTS : serves
    CHANNELS ||--o{ CHANNEL_STATS : aggregates
    
    PUBLICATIONS ||--o{ VIEWS_DAILY : measures
    
    INVITES ||--o{ CLIENTS : via
    
    PLANS ||--o{ SUBSCRIPTIONS : selected
    PLANS ||--o{ GIFTS_QUEUE : giftPlan
    
    CONTRACTORS {
        bigint id PK
        bigint tg_user_id UK
        text username
        text full_name
        text status
        timestamptz created_at
    }
    
    CHANNELS {
        bigint id PK
        bigint contractor_id FK
        bigint tg_chat_id UK
        text title
        text username
        timestamptz created_at
    }
    
    PUBLICATIONS {
        bigint id PK
        bigint channel_id FK
        bigint message_id
        text file_name
        text file_type
        int views
        timestamptz posted_at
        boolean deleted
    }
    
    INVITES {
        bigint id PK
        bigint channel_id FK
        text token UK
        timestamptz expires_at
        int max_uses
        int used_count
        timestamptz created_at
    }
    
    CLIENTS {
        bigint id PK
        bigint channel_id FK
        bigint invite_id FK
        bigint tg_user_id
        text username
        text full_name
        timestamptz joined_at
        boolean blocked
    }
    
    SUBSCRIPTIONS {
        bigint id PK
        bigint contractor_id FK
        bigint plan_id FK
        text status
        timestamptz starts_at
        timestamptz expires_at
        text source
    }
    
    PLANS {
        bigint id PK
        text code UK
        text name
        numeric price_month
        jsonb features
        int channels_limit_one_off
    }
```

### 8.2. –°—Ö–µ–º–∞ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

```mermaid
graph TB
    subgraph "Core Schema"
        C[contractors]
        CH[channels]
        P[publications]
        I[invites]
        CL[clients]
    end
    
    subgraph "Billing Schema"
        PL[plans]
        S[subscriptions]
        UC[usage_counters]
        GQ[gifts_queue]
    end
    
    subgraph "Analytics Schema"
        VD[views_daily]
        CS[channel_stats]
        E[events]
    end
    
    C -->|1:N| CH
    C -->|1:1| S
    C -->|1:1| UC
    C -->|1:N| GQ
    
    PL -->|1:N| S
    PL -->|1:N| GQ
    
    CH -->|1:N| P
    CH -->|1:N| I
    CH -->|1:N| CL
    CH -->|1:1| CS
    
    I -->|1:N| CL
    
    P -->|1:N| VD
    
    CH -->|1:N| E
    CL -->|1:N| E
    
    style C fill:#87CEEB
    style CH fill:#DDA0DD
    style P fill:#90EE90
    style S fill:#FFB6C1
```

---

## 9. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è

### 9.1. Docker Compose –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
graph TB
    subgraph "Reverse Proxy"
        Traefik[Traefik<br/>Port: 80, 443<br/>SSL: Let's Encrypt]
    end
    
    subgraph "Database Layer"
        PostgreSQL[(PostgreSQL<br/>Port: 5432<br/>Volume: pgdata)]
        Redis[(Redis<br/>Port: 6379)]
    end
    
    subgraph "Application Layer"
        Backend[Backend API<br/>Port: 8000<br/>Health: /health]
        Userbot[Userbot API<br/>Port: 8001<br/>Health: /health]
        Bot[Telegram Bot<br/>Polling]
    end
    
    subgraph "Worker Layer"
        WorkerPDF[Worker PDF<br/>Queue: pdf<br/>Metrics: 9464]
        WorkerOffice[Worker Office<br/>Queue: office<br/>Metrics: 9466]
        WorkerPublish[Worker Publish<br/>Queue: publish<br/>Metrics: 9465]
        WorkerPreview[Worker Preview<br/>Queue: preview<br/>Metrics: 9467]
    end
    
    subgraph "Monitoring"
        Flower[Flower<br/>Port: 5555<br/>Celery Monitor]
    end
    
    subgraph "Storage"
        Sessions[Volume: userbot_sessions<br/>Encrypted .session.enc files]
        LetsEncrypt[Volume: traefik_letsencrypt<br/>SSL Certificates]
    end
    
    Traefik --> Userbot
    Traefik --> Backend
    
    Backend --> PostgreSQL
    Userbot --> PostgreSQL
    Userbot --> Sessions
    Bot --> PostgreSQL
    Bot --> Redis
    Bot --> Userbot
    Bot --> Backend
    
    WorkerPDF --> Redis
    WorkerPDF --> PostgreSQL
    WorkerOffice --> Redis
    WorkerOffice --> PostgreSQL
    WorkerPublish --> Redis
    WorkerPublish --> PostgreSQL
    WorkerPreview --> Redis
    
    Flower --> Redis
    
    style Traefik fill:#2ea6ff,color:#fff
    style PostgreSQL fill:#336791,color:#fff
    style Redis fill:#dc382d,color:#fff
    style Userbot fill:#00d4aa,color:#fff
```

### 9.2. –°—Ö–µ–º–∞ —Å–µ—Ç–µ–π

```mermaid
graph LR
    subgraph "External Network"
        Internet[Internet]
    end
    
    subgraph "Traefik Network"
        Traefik[Traefik]
        UserbotExt[Userbot<br/>External Access]
    end
    
    subgraph "Default Network"
        Bot[Bot]
        Backend[Backend]
        UserbotInt[Userbot<br/>Internal]
        Workers[Workers]
        PostgreSQL[(PostgreSQL)]
        Redis[(Redis)]
    end
    
    Internet -->|HTTPS| Traefik
    Traefik -->|HTTP| UserbotExt
    Traefik -->|HTTP| Backend
    
    Bot -->|HTTP| UserbotInt
    Bot -->|HTTP| Backend
    Bot -->|Tasks| Redis
    Bot -->|Queries| PostgreSQL
    
    UserbotInt -->|Queries| PostgreSQL
    UserbotExt -->|HTTP| UserbotInt
    
    Workers -->|Tasks| Redis
    Workers -->|Queries| PostgreSQL
    
    style Internet fill:#90EE90
    style Traefik fill:#2ea6ff,color:#fff
    style PostgreSQL fill:#336791,color:#fff
    style Redis fill:#dc382d,color:#fff
```

---

## 10. –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### 10.1. –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –æ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

```mermaid
sequenceDiagram
    participant U as –ü–æ–¥—Ä—è–¥—á–∏–∫
    participant B as Bot
    participant R as Redis
    participant WP as Worker Preview
    participant WR as Worker Render
    participant WPUB as Worker Publish
    participant T as Telegram API
    participant DB as PostgreSQL

    U->>B: –ó–∞–≥—Ä—É–∑–∏—Ç—å PDF
    B->>R: SET pdf:uuid [bytes] EX 86400
    B->>WP: generate_preview_task(pdf_key)
    
    WP->>R: GET pdf:uuid
    R-->>WP: [bytes]
    WP->>WP: PDF ‚Üí PNG ‚Üí JPEG (thumbnail)
    WP->>R: SET preview:uuid [thumbnail] EX 3600
    WP-->>B: –ü—Ä–µ–≤—å—é –≥–æ—Ç–æ–≤–æ
    
    B->>U: –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é, –≤—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    U->>B: –°—Ç—Ä–∞–Ω–∏—Ü—ã [1,3,5], –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ "–ò–≤–∞–Ω–æ–≤"
    
    B->>WR: process_and_publish_pdf(chat_id, pdf_key, pages, watermark)
    WR->>R: GET pdf:uuid
    R-->>WR: [bytes]
    R->>R: DEL pdf:uuid
    
    loop –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        WR->>WR: PDF ‚Üí PNG 300 DPI
        WR->>WR: apply_watermark("–ò–≤–∞–Ω–æ–≤")
        WR->>WPUB: send_document(chat_id, png_bytes, protect_content=True)
        WPUB->>T: sendDocument(chat_id, document, protect_content=True)
        T-->>WPUB: {ok: true, message_id: 123}
        WPUB->>DB: INSERT INTO core.publications (channel_id, message_id, file_name, views)
    end
    
    WR-->>B: –£—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ
    B->>U: ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω
```

### 10.2. –°—Ö–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∏ retry

```mermaid
flowchart TD
    Start([–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞]) --> Send[Telegram API: sendDocument]
    
    Send --> CheckResult{–†–µ–∑—É–ª—å—Ç–∞—Ç}
    
    CheckResult -->|ok: true| Success[–£—Å–ø–µ—Ö]
    CheckResult -->|Error 403| Retry403{Retry<br/>403?}
    CheckResult -->|Error 429| Retry429[FloodWait<br/>–ü–æ–¥–æ–∂–¥–∞—Ç—å N —Å–µ–∫—É–Ω–¥]
    CheckResult -->|Error 400| LogError[–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É]
    CheckResult -->|Network Error| RetryNetwork[Retry —á–µ—Ä–µ–∑ 5 —Å–µ–∫]
    
    Retry403 -->|–î–∞| Wait403[–ü–æ–¥–æ–∂–¥–∞—Ç—å 10 —Å–µ–∫]
    Wait403 --> Send
    Retry403 -->|–ù–µ—Ç| LogError
    
    Retry429 --> Wait429[–ü–æ–¥–æ–∂–¥–∞—Ç—å N —Å–µ–∫—É–Ω–¥]
    Wait429 --> Send
    
    RetryNetwork --> CheckRetries{–ü–æ–ø—ã—Ç–æ–∫<br/>< 3?}
    CheckRetries -->|–î–∞| Send
    CheckRetries -->|–ù–µ—Ç| LogError
    
    Success --> SaveDB[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î]
    SaveDB --> End([–ì–æ—Ç–æ–≤–æ])
    
    LogError --> End
    
    style Start fill:#90EE90
    style End fill:#FFB6C1
    style Success fill:#87CEEB
    style LogError fill:#FF6B6B
```

---

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

### –£—Å–ª–æ–≤–Ω—ã–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è

- **–ó–µ–ª—ë–Ω—ã–π** ‚Äî –Ω–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
- **–†–æ–∑–æ–≤—ã–π** ‚Äî –∫–æ–Ω–µ—Ü –ø—Ä–æ—Ü–µ—Å—Å–∞
- **–ì–æ–ª—É–±–æ–π** ‚Äî –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- **–§–∏–æ–ª–µ—Ç–æ–≤—ã–π** ‚Äî —É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- **–ö—Ä–∞—Å–Ω—ã–π** ‚Äî –æ—à–∏–±–∫–∏

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

1. **QR-–∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `client.qr_login()` –∏–∑ Telethon, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç QR-–∫–æ–¥ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Telegram Desktop/Web
2. **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π**: Fernet —Å –∫–ª—é—á–æ–º –∏–∑ `SESSION_SECRET`
3. **TTL –≤ Redis**: 
   - –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã: 24 —á–∞—Å–∞
   - –ü—Ä–µ–≤—å—é: 1 —á–∞—Å
   - –ü–æ–ª–Ω—ã–µ PNG: 12 —á–∞—Å–æ–≤
4. **–ó–∞—â–∏—Ç–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞**: –í—Å–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å `protect_content=True` –∏ `ToggleNoForwardsRequest`

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2024  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2024

